---
import "../styles/global.css";
import "../styles/animations.css";
import "../styles/sophisticated-design.css";
import "../styles/broken-grid.css";
import "../styles/dark-mode-2.css";
import "../styles/scroll-driven-animations.css";
import "../styles/container-queries.css";
import "../styles/view-transitions-enhanced.css";
import FluidGradient from "../components/FluidGradient.astro";
import SEO from "../components/SEO.astro";
import SchemaOrganization from "../components/SchemaOrganization.astro";
import LanguageSwitcher from "../components/LanguageSwitcher.astro";
import { ClientRouter } from "astro:transitions";
import ReadingProgress from "../components/ReadingProgress.astro";

import {
    getLangFromUrl,
    getLocalizedPath,
    useTranslations,
} from "../i18n/utils";

interface Props {
    seo?: {
        title?: string;
        description?: string;
        keywords?: string;
        ogImage?: string;
        ogType?: "website" | "article";
        article?: {
            publishedTime?: string;
            author?: string;
        };
    };
}

const { seo = {} } = Astro.props;

// Get current language from URL
const currentLang = getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);

// Helper to get localized path
const l = (path: string) => getLocalizedPath(path, currentLang);

// Active state helper for navigation
const pathname = Astro.url.pathname;
const isActive = (path: string) => {
    const target = getLocalizedPath(path, currentLang);
    return (
        pathname === target ||
        pathname === `${target}/` ||
        pathname.startsWith(`${target}/`)
    );
};

// Navigation labels based on language
const nav = {
    about: "About",
    aboutUs: currentLang === "en" ? "About Us" : "私たちについて",
    history: currentLang === "en" ? "History" : "設立の経緯",
    members: currentLang === "en" ? "Members" : "メンバー紹介",
    events: "Events",
    upcoming: currentLang === "en" ? "Upcoming Events" : "今後の予定",
    past: currentLang === "en" ? "Past Lectures" : "過去の講演会",
    media: "Media",
    faq: "FAQ",
    sponsors: "Sponsors",
    contact: "Contact",
    contactMobile: currentLang === "en" ? "Contact" : "お問い合わせ",
    speakerRequest: "Request",
    speakerRequestMobile: currentLang === "en" ? "Request" : "講演者リクエスト",
};
---

<!doctype html>
<html lang={currentLang}>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />

        <!-- Favicons -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="apple-touch-icon" href="/favicon.svg" />
        <link rel="manifest" href="/site.webmanifest" />

        <meta name="generator" content={Astro.generator} />

        <!-- SEO Meta Tags -->
        <SEO {...seo} />

        <!-- ClientRouter for smooth page navigation -->
        <ClientRouter />

        <!-- DNS Prefetch for faster resolution -->
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
        <link rel="dns-prefetch" href="https://images.microcms-assets.io" />
        <link rel="dns-prefetch" href="https://unpkg.com" />

        <!-- Preconnect for critical origins (images are priority) -->
        <link
            rel="preconnect"
            href="https://images.microcms-assets.io"
            crossorigin
        />
        
        <!-- Google Fonts: Shippori Mincho (Japanese Mincho) & Lato (Geometric Sans) -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;600;700&family=Lato:wght@300;400;700&display=swap"
            rel="stylesheet"
        />

        <!-- Critical CSS Inline for instant render -->
        <style>
            /* Critical above-the-fold styles */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            html {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                /* Japanese text line break control */
                word-break: keep-all;
                overflow-wrap: break-word;
                hyphens: none;
                /*
                  背景が transparent だと、iOS/Safari のオーバースクロール等で
                  背景が白く“浮いて”見えることがあるため、ベース背景を固定。
                  背景レイヤー（FluidGradient）は別途 fixed 要素として描画。
                */
                background-color: var(--bg-primary, #fef9f4);
            }

            body {
                /* Base background to avoid seams/overscroll artifacts */
                color: #333333;
                min-height: 100vh;
                line-height: 1.75;
                background-color: var(--bg-primary, #fef9f4);
                /* Japanese text line break control */
                word-break: keep-all;
                overflow-wrap: break-word;
                hyphens: none;
                line-break: strict;
            }
        </style>

        <!-- Lightweight Progress Bar (no external dependencies) -->
        <style>
            /* Ultra-light CSS-only progress bar */
            #page-progress {
                position: fixed;
                top: 0;
                left: 0;
                width: 0%;
                height: 3px;
                background: linear-gradient(90deg, #006837, #00a855);
                z-index: 99999;
                transition: width 0.1s ease-out;
                box-shadow: 0 0 10px rgba(0, 104, 55, 0.5);
            }
            #page-progress.active {
                width: 30%;
                animation: progress-trickle 0.5s ease-out forwards;
            }
            #page-progress.complete {
                width: 100%;
                transition:
                    width 0.15s ease-out,
                    opacity 0.3s ease-out 0.15s;
                opacity: 0;
            }
            @keyframes progress-trickle {
                0% {
                    width: 30%;
                }
                100% {
                    width: 80%;
                }
            }
        </style>

        <script is:inline>
            // Lightweight progress bar - no external dependencies
            (function () {
                // Create progress element immediately
                const progress = document.createElement("div");
                progress.id = "page-progress";
                document.documentElement.appendChild(progress);

                // Astro View Transitions integration
                document.addEventListener("astro:before-preparation", () => {
                    progress.classList.remove("complete");
                    progress.classList.add("active");
                });

                document.addEventListener("astro:after-swap", () => {
                    progress.classList.remove("active");
                    progress.classList.add("complete");
                });

                document.addEventListener("astro:page-load", () => {
                    progress.classList.remove("active");
                    progress.classList.add("complete");
                    // Reset after animation
                    setTimeout(() => {
                        progress.classList.remove("complete");
                        progress.style.width = "0%";
                        progress.style.opacity = "1";
                    }, 500);
                });
            })();
        </script>

        <!-- Google Analytics 4 (Deferred for better performance) -->
        <script is:inline>
            // Defer GA loading until after page load
            window.addEventListener("load", function () {
                setTimeout(function () {
                    var script = document.createElement("script");
                    script.src =
                        "https://www.googletagmanager.com/gtag/js?id=G-V93QY7FJZS";
                    script.async = true;
                    document.head.appendChild(script);

                    window.dataLayer = window.dataLayer || [];
                    function gtag() {
                        dataLayer.push(arguments);
                    }
                    window.gtag = gtag;
                    gtag("js", new Date());
                    gtag("config", "G-V93QY7FJZS");
                }, 100);
            });

            // Font loading detection
            if ("fonts" in document) {
                document.fonts.ready.then(function () {
                    document.documentElement.classList.add("fonts-loaded");
                });
            }
        </script>
        <style is:global>
            /* ===== Smooth View Transitions ===== */

            /* Smooth fade with subtle slide */
            @keyframes smooth-fade-out {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-8px);
                }
            }

            @keyframes smooth-fade-in {
                from {
                    opacity: 0;
                    transform: translateY(8px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Root transition - short and snappy for responsiveness */
            ::view-transition-old(root) {
                animation: smooth-fade-out 0.3s cubic-bezier(0.4, 0, 0.2, 1)
                    forwards;
            }

            ::view-transition-new(root) {
                animation: smooth-fade-in 0.4s cubic-bezier(0.16, 1, 0.3, 1)
                    forwards;
            }

            /* Breadcrumb - slightly faster */
            .breadcrumb-nav {
                view-transition-name: breadcrumb;
            }

            ::view-transition-old(breadcrumb),
            ::view-transition-new(breadcrumb) {
                animation-duration: 300ms;
            }

            /* Prevent overflow during transitions */
            ::view-transition-image-pair(*) {
                overflow: hidden;
            }

            /* All groups - shorter, snappier timing for better responsiveness */
            ::view-transition-group(*) {
                animation-duration: 0.4s;
                animation-timing-function: cubic-bezier(0.16, 1, 0.3, 1);
            }

            /* CRITICAL: Allow interaction during ALL transitions */
            ::view-transition-new(*),
            ::view-transition-old(*) {
                pointer-events: none !important;
            }

            /* Enable pointer events on the document during transitions */
            html::view-transition,
            html:has(::view-transition) {
                pointer-events: auto !important;
            }

            /* Ensure body and all interactive elements remain clickable */
            body,
            a,
            button,
            [role="button"],
            input,
            select,
            textarea {
                pointer-events: auto !important;
            }

            /* Enhanced motion sensitivity support */
            @media (prefers-reduced-motion: reduce) {
                ::view-transition-group(*),
                ::view-transition-old(*),
                ::view-transition-new(*) {
                    animation: none !important;
                    animation-duration: 0ms !important;
                }
            }

            /* CSS Variables for Dark Mode */
            :root {
                /* Legacy Dark Mode Variables (保持) */
                /* Warm, washi-like base to match the FluidGradient layer */
                --bg-primary: #fef9f4;
                --bg-secondary: #faf7f2;
                --bg-gradient-start: #fef9f4;
                --bg-gradient-end: #f0ede8;
                --text-primary: #111827;
                --text-secondary: #4b5563;
                --text-tertiary: #6b7280;
                --border-color: #e5e7eb;
                --border-color-hover: rgba(0, 104, 55, 0.3);
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

                /* ===== Design Token System ===== */

                /* Primary Color Scale */
                --color-primary-50: #e6f7ef;
                --color-primary-100: #ccefdf;
                --color-primary-200: #99dfbf;
                --color-primary-300: #66cf9f;
                --color-primary-400: #33bf7f;
                --color-primary-500: #006837;
                --color-primary-600: #005028;
                --color-primary-700: #003c1e;
                --color-primary-800: #002814;
                --color-primary-900: #00140a;

                /* Gray Scale - Washi-inspired tones */
                --color-washi: #F9F9F7;
                --color-washi-warm: #F7F5F0;
                --color-gray-50: #f9fafb;
                --color-gray-100: #f3f4f6;
                --color-gray-200: #e5e7eb;
                --color-gray-300: #d1d5db;
                --color-gray-400: #9ca3af;
                --color-gray-500: #6b7280;
                --color-gray-600: #4b5563;
                --color-gray-700: #374151;
                --color-gray-800: #1f2937;
                --color-gray-900: #111827;
                
                /* Akita Cedar-inspired colors */
                --color-cedar-brown: #8B6F47;
                --color-cedar-dark: #6B5433;
                --color-cedar-light: #A68B6B;
                
                /* Accent colors - muted warm tones */
                --color-accent-vermilion: #C85A3A;
                --color-accent-yamabuki: #E6B422;

                /* Semantic Colors */
                --color-success: #10b981;
                --color-warning: #f59e0b;
                --color-error: #ef4444;
                --color-info: #3b82f6;

                /* Typography */
                --font-sans:
                    "Noto Sans JP", "Noto Sans JP Fallback", -apple-system, BlinkMacSystemFont,
                    sans-serif;
                --font-geometric: "Lato", "Noto Sans JP", sans-serif;
                --font-mincho: "Shippori Mincho", "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "Hiragino Mincho Pro", "HiraMinProN-W3", "MS PMincho", serif;
                --font-mono: "SF Mono", Monaco, "Cascadia Code", monospace;
                
                /* Letter spacing for geometric fonts */
                --letter-spacing-wide: 0.05em;
                --letter-spacing-wider: 0.1em;

                --font-size-xs: 0.75rem;
                --font-size-sm: 0.875rem;
                --font-size-base: 1rem;
                --font-size-lg: 1.125rem;
                --font-size-xl: 1.25rem;
                --font-size-2xl: 1.5rem;
                --font-size-3xl: 1.875rem;
                --font-size-4xl: 2.25rem;
                --font-size-5xl: 3rem;
                --font-size-6xl: 3.75rem;

                --font-weight-normal: 400;
                --font-weight-medium: 500;
                --font-weight-semibold: 600;
                --font-weight-bold: 700;

                --line-height-tight: 1.25;
                --line-height-normal: 1.5;
                --line-height-relaxed: 1.75;
                --line-height-loose: 2;

                /* Spacing (4px base) */
                --space-0: 0;
                --space-1: 0.25rem;
                --space-2: 0.5rem;
                --space-3: 0.75rem;
                --space-4: 1rem;
                --space-5: 1.25rem;
                --space-6: 1.5rem;
                --space-8: 2rem;
                --space-10: 2.5rem;
                --space-12: 3rem;
                --space-16: 4rem;
                --space-20: 5rem;
                --space-24: 6rem;

                /* Transitions */
                --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
                --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
                --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);

                --ease-in: cubic-bezier(0.4, 0, 1, 1);
                --ease-out: cubic-bezier(0, 0, 0.2, 1);
                --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);

                /* Border Radius */
                --radius-sm: 0.25rem;
                --radius-md: 0.5rem;
                --radius-lg: 0.75rem;
                --radius-xl: 1rem;
                --radius-full: 9999px;

                /* Z-Index Scale */
                --z-base: 0;
                --z-dropdown: 10;
                --z-sticky: 20;
                --z-fixed: 30;
                --z-modal-backdrop: 40;
                --z-modal: 50;
                --z-popover: 60;
                --z-tooltip: 70;
                /* Scroll reactive background */
                --scroll-bg-strength: 0;
            }

            [data-theme="dark"] {
                --bg-primary: #1c1c1e; /* macOS dark card */
                --bg-secondary: #000000; /* macOS black background */
                --bg-gradient-start: #000000;
                --bg-gradient-end: #1c1c1e;
                --text-primary: #ffffff; /* Pure white */
                --text-secondary: #ebebf5; /* macOS secondary label */
                --text-tertiary: #ebebf599; /* macOS tertiary label */
                --border-color: #38383a; /* macOS separator */
                --border-color-hover: rgba(50, 215, 75, 0.4); /* macOS green */
                --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            }

            html {
                scroll-behavior: smooth;
                background-color: var(--bg-primary);
                transition: background-color 0.3s ease;
            }

            body {
                background-color: var(--bg-primary);
                color: var(--text-primary);
                transition:
                    background-color 0.3s ease,
                    color 0.3s ease;
            }

            /* Subtle scroll-reactive background overlay */
            body::before {
                content: "";
                position: fixed;
                inset: 0;
                pointer-events: none;
                z-index: -1;
                background:
                    radial-gradient(
                        circle at 10% 0%,
                        rgba(0, 104, 55, 0.16) 0,
                        transparent 55%
                    ),
                    radial-gradient(
                        circle at 90% 100%,
                        rgba(0, 168, 85, 0.18) 0,
                        transparent 55%
                    );
                opacity: calc(0.15 + var(--scroll-bg-strength, 0) * 0.5);
                transition: opacity 0.25s ease-out;
            }

            /* Comprehensive Dark Mode Styles - macOS Inspired */

            /* Background Colors - Natural, softer tones */
            [data-theme="dark"] .bg-white {
                background-color: #1c1c1e !important; /* macOS dark card background */
            }

            [data-theme="dark"] .bg-gray-50 {
                background-color: #000000 !important; /* macOS true black background */
            }

            [data-theme="dark"] .bg-gray-100 {
                background-color: #2c2c2e !important; /* macOS secondary background */
            }

            [data-theme="dark"] .bg-gradient-to-b {
                background-image: linear-gradient(
                    to bottom,
                    #000000,
                    #1c1c1e
                ) !important;
            }

            /* Accent color - slightly muted for dark mode */
            [data-theme="dark"] .bg-\[\#006837\] {
                background-color: #34c759 !important; /* macOS system green */
            }

            /* Text Colors - Natural contrast */
            [data-theme="dark"] .text-gray-900,
            [data-theme="dark"] .text-gray-800,
            [data-theme="dark"] .text-gray-700 {
                color: #ffffff !important; /* Pure white for primary text */
            }

            [data-theme="dark"] .text-gray-600 {
                color: #ebebf5 !important; /* macOS secondary label */
            }

            [data-theme="dark"] .text-gray-500 {
                color: #ebebf599 !important; /* macOS tertiary label - 60% opacity */
            }

            [data-theme="dark"] .text-gray-400 {
                color: #ebebf54d !important; /* macOS quaternary label - 30% opacity */
            }

            [data-theme="dark"] .text-gray-300 {
                color: #ebebf533 !important; /* Subtle text - 20% opacity */
            }

            /* Accent text colors */
            [data-theme="dark"] .text-\[\#006837\] {
                color: #32d74b !important; /* macOS system green (lighter) */
            }

            [data-theme="dark"] .hover\:text-\[\#006837\]:hover {
                color: #30d158 !important;
            }

            /* Links - Natural appearance */
            [data-theme="dark"]
                a:not(.bg-\[\#006837\]):not(.bg-black):not(.bg-gradient-to-r) {
                color: #ebebf5;
            }

            [data-theme="dark"] a:hover {
                color: #32d74b; /* macOS green on hover */
            }

            /* Borders - Subtle separators */
            [data-theme="dark"] .border-gray-200,
            [data-theme="dark"] .border-gray-100 {
                border-color: #38383a !important; /* macOS separator */
            }

            [data-theme="dark"] .border-t,
            [data-theme="dark"] .border-b,
            [data-theme="dark"] .border-l {
                border-color: #38383a !important;
            }

            [data-theme="dark"] .border-\[\#006837\] {
                border-color: #32d74b !important;
            }

            /* Shadows - Softer, more natural */
            [data-theme="dark"] .shadow-sm {
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3) !important;
            }

            [data-theme="dark"] .shadow-md {
                box-shadow:
                    0 4px 6px -1px rgba(0, 0, 0, 0.4),
                    0 2px 4px -1px rgba(0, 0, 0, 0.3) !important;
            }

            [data-theme="dark"] .shadow-lg {
                box-shadow:
                    0 10px 15px -3px rgba(0, 0, 0, 0.5),
                    0 4px 6px -2px rgba(0, 0, 0, 0.3) !important;
            }

            [data-theme="dark"] .shadow-xl {
                box-shadow:
                    0 20px 25px -5px rgba(0, 0, 0, 0.6),
                    0 10px 10px -5px rgba(0, 0, 0, 0.4) !important;
            }

            /* Header - Fixed backdrop blur issue */
            [data-theme="dark"] header {
                background-color: rgba(
                    28,
                    28,
                    30,
                    0.8
                ) !important; /* Semi-transparent dark */
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border-bottom-color: #38383a !important;
            }

            /* Footer */
            [data-theme="dark"] footer {
                background-color: rgba(28, 28, 30, 0.78) !important;
                backdrop-filter: blur(18px) saturate(160%);
                -webkit-backdrop-filter: blur(18px) saturate(160%);
                border-top-color: #38383a !important;
            }

            /* Header/Footer surfaces should blend with the warm washi background */
            #site-header.glass-nav {
                background-color: rgba(254, 249, 244, 0.72);
                border-bottom: 1px solid rgba(17, 24, 39, 0.06);
                box-shadow:
                    0 10px 30px rgba(17, 24, 39, 0.06),
                    0 1px 0 rgba(255, 255, 255, 0.65) inset;
                backdrop-filter: blur(18px) saturate(160%);
                -webkit-backdrop-filter: blur(18px) saturate(160%);
            }

            /* Footer: slightly more opaque than body, but still lets texture show through */
            footer.site-footer {
                padding: 64px 24px;
                background-color: rgba(254, 249, 244, 0.62);
                border-top: 1px solid rgba(17, 24, 39, 0.06);
                backdrop-filter: blur(14px) saturate(150%);
                -webkit-backdrop-filter: blur(14px) saturate(150%);
            }

            /* Footer inner dividers should match the softer border */
            footer.site-footer [style*="border-top: 1px solid #e5e7eb"] {
                border-top-color: rgba(17, 24, 39, 0.08) !important;
            }

            /* Dark mode: keep header consistent with the same translucency approach */
            [data-theme="dark"] #site-header.glass-nav {
                background-color: rgba(28, 28, 30, 0.78) !important;
                border-bottom-color: #38383a !important;
                box-shadow:
                    0 10px 30px rgba(0, 0, 0, 0.45),
                    0 1px 0 rgba(255, 255, 255, 0.04) inset;
            }

            /* Hover States - Subtle */
            [data-theme="dark"] .hover\:bg-gray-50:hover {
                background-color: #2c2c2e !important;
            }

            /* Dropdown Menus */
            [data-theme="dark"] .dropdown-menu {
                background-color: rgba(44, 44, 46, 0.95) !important;
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border-color: #38383a !important;
            }

            /* Font Display Optimization with size-adjust for CLS prevention */
            @font-face {
                font-family: "Noto Sans JP Fallback";
                src: local("Arial"), local("Helvetica");
                size-adjust: 100%;
                ascent-override: 95%;
                descent-override: 25%;
                line-gap-override: 0%;
            }
            
            @font-face {
                font-family: "Noto Sans JP";
                font-display: swap;
            }

            /* CSS Containment for Performance */
            .lecture-card,
            .event-card {
                contain: layout style paint;
            }

            .container {
                contain: layout;
            }

            /* Enhanced Focus for WCAG 2.2 Compliance */
            a:focus-visible,
            button:focus-visible,
            input:focus-visible,
            textarea:focus-visible,
            select:focus-visible {
                outline: 3px solid #006837;
                outline-offset: 3px;
                border-radius: 4px;
                position: relative;
                z-index: 100; /* Ensure focus is not obscured */
                transition: outline-offset 0.2s ease;
            }

            /* Focus Appearance - Enhanced contrast */
            [data-theme="dark"] a:focus-visible,
            [data-theme="dark"] button:focus-visible,
            [data-theme="dark"] input:focus-visible,
            [data-theme="dark"] textarea:focus-visible,
            [data-theme="dark"] select:focus-visible {
                outline-color: #32d74b;
            }

            /* Remove outline for mouse users */
            a:focus:not(:focus-visible),
            button:focus:not(:focus-visible) {
                outline: none;
            }

            /* Touch Target Size Optimization - WCAG 2.2 */
            /* Exclude header nav links */
            button,
            a:not(nav a):not(header a),
            input[type="submit"],
            input[type="button"] {
                min-height: 44px;
                min-width: 44px;
            }

            /* Skeleton Loading Animation */
            @keyframes skeleton-loading {
                0% {
                    background-position: -200px 0;
                }
                100% {
                    background-position: calc(200px + 100%) 0;
                }
            }

            .skeleton {
                background-color: #e0e0e0;
                background-image: linear-gradient(
                    90deg,
                    #e0e0e0 0px,
                    #f0f0f0 40px,
                    #e0e0e0 80px
                );
                background-size: 200px 100%;
                background-repeat: no-repeat;
                animation: skeleton-loading 1.2s ease-in-out infinite;
            }

            [data-theme="dark"] .skeleton {
                background-color: #374151;
                background-image: linear-gradient(
                    90deg,
                    #374151 0px,
                    #4b5563 40px,
                    #374151 80px
                );
            }

            .skeleton-text {
                height: 1rem;
                margin-bottom: 0.5rem;
                border-radius: 0.25rem;
            }

            .skeleton-text.short {
                width: 60%;
            }

            .skeleton-image {
                width: 100%;
                aspect-ratio: 3/4;
                border-radius: 0.5rem 0.5rem 0 0;
            }

            /* Toast Notifications */
            .toast-container {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 10000;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .toast {
                min-width: 300px;
                max-width: 400px;
                padding: 16px 20px;
                border-radius: 8px;
                background: white;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                gap: 12px;
                transform: translateX(400px);
                opacity: 0;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .toast.show {
                transform: translateX(0);
                opacity: 1;
            }

            .toast-success {
                border-left: 4px solid #10b981;
            }

            .toast-error {
                border-left: 4px solid #ef4444;
            }

            .toast-info {
                border-left: 4px solid #3b82f6;
            }

            .toast-icon {
                flex-shrink: 0;
                width: 20px;
                height: 20px;
            }

            .toast-message {
                flex: 1;
                font-size: 14px;
                line-height: 1.5;
                color: #1f2937;
            }

            [data-theme="dark"] .toast {
                background: #1f2937;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
            [data-theme="dark"] .toast-message {
                color: #f9fafb;
            }

            /* Feedback Button Animation */
            @keyframes pulse-slow {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.85;
                }
            }

            .animate-pulse-slow {
                animation: pulse-slow 3s ease-in-out infinite;
            }

            #feedback-button:hover {
                animation: none;
            }

            ::selection {
                background-color: #006837;
                color: white;
            }

            /* Micro-interactions */

            /* Ripple Effect for Buttons */
            @keyframes ripple {
                0% {
                    transform: scale(0);
                    opacity: 0.6;
                }
                100% {
                    transform: scale(2.5);
                    opacity: 0;
                }
            }

            .ripple-effect {
                position: relative;
                overflow: hidden;
            }

            .ripple-effect::after {
                content: "";
                position: absolute;
                top: 50%;
                left: 50%;
                width: 20px;
                height: 20px;
                background: rgba(255, 255, 255, 0.5);
                border-radius: 50%;
                transform: translate(-50%, -50%) scale(0);
                pointer-events: none;
            }

            .ripple-effect:active::after {
                animation: ripple 0.6s ease-out;
            }

            /* Card hover effect (3D tilt removed - only shadow effect) */
            .card-tilt {
                transition:
                    box-shadow 0.3s ease;
                box-shadow:
                    0 4px 20px -8px rgba(0, 104, 55, 0.08);
            }

            @media (hover: hover) {
                .card-tilt:hover {
                    box-shadow:
                        0 12px 40px -10px rgba(0, 104, 55, 0.15);
                }
            }

            /* Smooth hover transitions */
            .smooth-hover {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Will-change for performance optimization */
            .smooth-hover {
                will-change: transform;
            }

            /* ===== CSS content-visibility for Performance ===== */
            /* Dramatically improves rendering speed by skipping off-screen content */

            .content-visibility-auto {
                content-visibility: auto;
                contain-intrinsic-size: 0 400px;
            }

            /* Member cards optimization */
            .member-card {
                content-visibility: auto;
                contain-intrinsic-size: 0 350px;
            }

            /* Lecture cards optimization */
            .lecture-card {
                content-visibility: auto;
                contain-intrinsic-size: 0 300px;
            }

            /* Shimmer loading effect for perceived performance */
            @keyframes shimmer {
                0% {
                    background-position: -1000px 0;
                }
                100% {
                    background-position: 1000px 0;
                }
            }

            .skeleton {
                background: linear-gradient(
                    90deg,
                    #f0f0f0 25%,
                    #e0e0e0 50%,
                    #f0f0f0 75%
                );
                background-size: 1000px 100%;
                animation: shimmer 2s infinite linear;
                border-radius: 4px;
            }

            [data-theme="dark"] .skeleton {
                background: linear-gradient(
                    90deg,
                    #2a2a2a 25%,
                    #1a1a1a 50%,
                    #2a2a2a 75%
                );
                background-size: 1000px 100%;
            }

            img.loading {
                background: linear-gradient(
                    90deg,
                    #f0f0f0 25%,
                    #e0e0e0 50%,
                    #f0f0f0 75%
                );
                background-size: 1000px 100%;
                animation: shimmer 2s infinite;
            }

            /* ===== Micro-interactions Enhancement ===== */
            /* Button feedback - subtle scale on click */
            button,
            .btn,
            a.button {
                transition:
                    transform var(--transition-fast),
                    box-shadow var(--transition-fast),
                    background-color var(--transition-fast);
            }

            button:active,
            .btn:active,
            a.button:active {
                transform: scale(0.98);
            }

            /* Enhanced link hover with underline animation */
            a:not(.button):not(.btn) {
                position: relative;
                transition: color var(--transition-fast);
            }

            a:not(.button):not(.btn)::after {
                content: "";
                position: absolute;
                width: 0;
                height: 2px;
                bottom: -2px;
                left: 0;
                background-color: #006837;
                transition: width var(--transition-base);
            }

            a:not(.button):not(.btn):hover::after {
                width: 100%;
            }

            /* Smooth page scroll */
            html {
                scroll-behavior: smooth;
            }

            @media (prefers-reduced-motion: reduce) {
                html {
                    scroll-behavior: auto;
                }

                button,
                .btn,
                a {
                    transition: none !important;
                }

                a::after {
                    transition: none !important;
                }
            }
            /* Remove will-change after interaction */
            @media (prefers-reduced-motion: reduce) {
                .smooth-hover {
                    will-change: auto;
                    transition: none;
                }
            }

            /* MailerLite embed styling to match site tone */
            :global(.ml-embedded form) {
                display: grid;
                gap: 12px;
            }

            :global(.ml-embedded input[type="email"]),
            :global(.ml-embedded input[type="text"]) {
                width: 100%;
                padding: 12px 14px;
                border: 1px solid #d1d5db;
                border-radius: 10px;
                font-size: 15px;
                line-height: 1.4;
                transition:
                    border-color 0.2s ease,
                    box-shadow 0.2s ease,
                    background-color 0.2s ease;
            }

            :global(.ml-embedded input[type="email"]::placeholder),
            :global(.ml-embedded input[type="text"]::placeholder) {
                color: #9ca3af;
            }

            :global(.ml-embedded input[type="email"]:focus),
            :global(.ml-embedded input[type="text"]:focus) {
                border-color: #006837;
                box-shadow: 0 0 0 3px rgba(0, 104, 55, 0.15);
                outline: none;
                background-color: #f8fafc;
            }

            :global(.ml-embedded button) {
                width: 100%;
                padding: 12px 14px;
                border-radius: 10px;
                background: #006837;
                color: white;
                font-weight: 700;
                border: none;
                cursor: pointer;
                transition:
                    transform 0.15s ease,
                    box-shadow 0.2s ease,
                    background-color 0.2s ease;
            }

            :global(.ml-embedded button:hover) {
                transform: translateY(-1px);
                box-shadow: 0 6px 14px rgba(0, 104, 55, 0.18);
                background-color: #0a7a3f;
            }

            :global(.ml-embedded button:active) {
                transform: translateY(0);
                box-shadow: 0 3px 8px rgba(0, 104, 55, 0.12);
            }
        </style>

        <!-- Structured Data -->
        <SchemaOrganization />

        <!-- MailerLite Universal -->
        <script>
            (function (w, d, e, u, f, l, n) {
                w[f] =
                    w[f] ||
                    function () {
                        (w[f].q = w[f].q || []).push(arguments);
                    };
                l = d.createElement(e);
                l.async = 1;
                l.src = u;
                n = d.getElementsByTagName(e)[0];
                n.parentNode.insertBefore(l, n);
            })(
                window,
                document,
                "script",
                "https://assets.mailerlite.com/js/universal.js",
                "ml",
            );
            ml("account", "2020217");
        </script>
        <!-- End MailerLite Universal -->
    </head>
    <body
        class="text-[#333333] font-sans antialiased min-h-screen flex flex-col tracking-wide font-normal selection:bg-[#006837] selection:text-white relative"
    >
        <ReadingProgress />
        <!-- Background Layer (Washi Texture + Fluid Gradient) -->
        <div class="fixed inset-0 z-[-1] pointer-events-none">
            <FluidGradient />
            <div class="absolute inset-0 washi-texture w-full h-full"></div>
        </div>

        <!-- Splash Screen -->
        <div id="splash-screen" class="splash-screen">
            <div class="splash-content">
                <img
                    src="/favicon.svg"
                    alt="AIU Cedar Society"
                    class="splash-logo"
                />
                <div class="splash-text">AIU Cedar Society</div>
            </div>
        </div>

        <style>
            /* Splash Screen Styles */
            .splash-screen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #ffffff;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                opacity: 1;
                visibility: visible;
                transition:
                    opacity 1s cubic-bezier(0.4, 0, 0.2, 1),
                    visibility 1s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Instant hide - applied by JS before page loads */
            .splash-screen.splash-hidden {
                display: none !important;
                opacity: 0 !important;
                visibility: hidden !important;
            }

            .splash-screen.hide {
                opacity: 0;
                visibility: hidden;
            }

            .splash-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                animation: fadeInUp 0.8s ease-out;
                transition:
                    transform 2s cubic-bezier(0.4, 0, 0.2, 1),
                    opacity 0.8s ease-out;
            }

            .splash-screen.hide .splash-content {
                transform: scale(20);
                opacity: 0;
            }

            .splash-logo {
                width: 120px;
                height: 120px;
                border-radius: 24px;
                box-shadow: 0 20px 60px rgba(0, 104, 55, 0.2);
                animation: pulse-logo 2s ease-in-out infinite;
                transition: transform 2s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .splash-text {
                margin-top: 24px;
                font-size: 1.5rem;
                font-weight: 700;
                color: #006837;
                letter-spacing: 0.1em;
                opacity: 0;
                animation: fadeIn 0.5s ease-out 0.3s forwards;
                transition: opacity 0.3s ease-out;
            }

            .splash-screen.hide .splash-text {
                opacity: 0 !important;
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            @keyframes pulse-logo {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
            }

            /* Hide body scroll when splash is visible */
            body.splash-active {
                overflow: hidden;
            }

            /* Reduced motion support */
            @media (prefers-reduced-motion: reduce) {
                .splash-screen {
                    transition:
                        opacity 0.3s ease-out,
                        visibility 0.3s ease-out;
                }
                .splash-content {
                    animation: none;
                    transition: none;
                }
                .splash-screen.hide .splash-content {
                    transform: none;
                }
                .splash-logo {
                    animation: none;
                    transition: none;
                }
                .splash-text {
                    animation: none;
                    opacity: 1;
                }
            }
        </style>

        <script is:inline>
            // Splash Screen Controller - Robust View Transitions Support
            (function () {
                // IMMEDIATELY hide splash if already shown (before any DOM parsing)
                const alreadyShown =
                    sessionStorage.getItem("splashShown") === "true";

                if (alreadyShown) {
                    // Inject CSS to hide splash immediately, even before DOM is ready
                    const style = document.createElement("style");
                    style.id = "splash-hide-style";
                    style.textContent =
                        "#splash-screen { display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; }";
                    document.head.appendChild(style);
                }

                function handleSplashScreen() {
                    const splash = document.getElementById("splash-screen");
                    if (!splash) return;

                    // CRITICAL: Check sessionStorage FIRST before any DOM operations
                    const splashShown = sessionStorage.getItem("splashShown");

                    // If already shown this session, hide immediately and never show again
                    if (splashShown === "true") {
                        splash.classList.add("splash-hidden");
                        splash.remove(); // Completely remove from DOM
                        return;
                    }

                    // Check if this is a page reload
                    const navEntries =
                        performance.getEntriesByType("navigation");
                    const isReload =
                        navEntries.length > 0 &&
                        navEntries[0].type === "reload";

                    if (isReload) {
                        splash.classList.add("splash-hidden");
                        splash.remove();
                        sessionStorage.setItem("splashShown", "true");
                        return;
                    }

                    // This is the first visit - show splash
                    document.body.classList.add("splash-active");

                    // Hide splash after 2 seconds (reduced from 3s)
                    setTimeout(function () {
                        splash.classList.add("hide");
                        document.body.classList.remove("splash-active");

                        // Mark as shown AFTER starting the hide animation
                        sessionStorage.setItem("splashShown", "true");

                        // Remove from DOM after animation (1 second fade out)
                        setTimeout(function () {
                            splash.remove();
                        }, 1000);
                    }, 2000);
                }

                // Run on initial page load
                handleSplashScreen();

                // Handle View Transitions - hide splash BEFORE swap happens
                document.addEventListener("astro:before-swap", function (e) {
                    if (sessionStorage.getItem("splashShown") === "true") {
                        // Completely remove splash from the new document
                        const newSplash =
                            e.newDocument.getElementById("splash-screen");
                        if (newSplash) {
                            newSplash.remove();
                        }
                    }
                });

                // Also listen to Astro's page load event for View Transitions (backup)
                document.addEventListener("astro:page-load", function () {
                    if (sessionStorage.getItem("splashShown") === "true") {
                        const splash = document.getElementById("splash-screen");
                        if (splash) {
                            splash.remove();
                        }
                    }
                });
            })();
        </script>

        <!-- HEADER -->
        <header
            id="site-header"
            class="fixed top-0 left-0 right-0 z-50 glass-nav"
        >
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 items-center justify-between">
                    <!-- Logo -->
                    <a href={l("/")} class="flex-shrink-0">
                        <span
                            class="text-lg md:text-xl font-mincho-bold text-gray-900 hover:text-[#006837] transition-colors tracking-wide"
                            style="letter-spacing: 0.05em;"
                        >
                            AIU Cedar Society
                        </span>
                    </a>

                    <!-- Desktop Navigation + Language Switcher -->
                    <div class="flex items-center gap-4 lg:gap-6">
                    <!-- Desktop Navigation -->
                    <nav
                        class="hidden lg:flex items-center"
                        style="gap: 1.5rem;"
                    >
                        <!-- About Dropdown -->
                        <div class="relative dropdown-container">
                            <button
                                class="dropdown-button nav-link typography-nav inline-flex items-center text-gray-600 hover:text-[#006837] text-sm transition-colors"
                                style="gap: 0.375rem;"
                                data-active={isActive("/about")}
                            >
                                About
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div
                                class="dropdown-menu absolute left-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-100 opacity-0 invisible transition-all duration-150"
                                style="z-index: 100;"
                            >
                                <a
                                    href={l("/about")}
                                    class="block px-4 py-2 text-sm typography-nav text-gray-700 hover:bg-gray-50 hover:text-[#006837]"
                                    >{nav.aboutUs}</a
                                >
                                <a
                                    href={l("/about/history")}
                                    class="block px-4 py-2 text-sm typography-nav text-gray-700 hover:bg-gray-50 hover:text-[#006837]"
                                    >{nav.history}</a
                                >
                                <a
                                    href={l("/about/members")}
                                    class="block px-4 py-2 text-sm typography-nav text-gray-700 hover:bg-gray-50 hover:text-[#006837]"
                                    >{nav.members}</a
                                >
                            </div>
                        </div>

                        <!-- Events Dropdown -->
                        <div class="relative dropdown-container">
                            <button
                                class="dropdown-button nav-link typography-nav inline-flex items-center text-gray-600 hover:text-[#006837] text-sm transition-colors"
                                style="gap: 0.375rem;"
                                data-active={isActive("/events")}
                            >
                                Events
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div
                                class="dropdown-menu absolute left-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-100 opacity-0 invisible transition-all duration-150"
                                style="z-index: 100;"
                            >
                                <a
                                    href={l("/events/upcoming")}
                                    class="block px-4 py-2 text-sm typography-nav text-gray-700 hover:bg-gray-50 hover:text-[#006837]"
                                    >{nav.upcoming}</a
                                >
                                <a
                                    href={l("/events/past")}
                                    class="block px-4 py-2 text-sm typography-nav text-gray-700 hover:bg-gray-50 hover:text-[#006837]"
                                    >{nav.past}</a
                                >
                            </div>
                        </div>

                        <!-- Media -->
                        <a
                            href={l("/media")}
                            class="nav-link typography-nav"
                            data-active={isActive("/media")}
                            >{nav.media}</a
                        ><!-- FAQ -->
                        <a
                            href={l("/faq")}
                            class="nav-link typography-nav"
                            data-active={isActive("/faq")}
                            >{nav.faq}</a
                        ><!-- Sponsors -->
                        <a
                            href={l("/sponsors")}
                            class="nav-link typography-nav"
                            data-active={isActive("/sponsors")}
                            >{nav.sponsors}</a
                        ><!-- Contact -->
                        <a
                            href={l("/contact")}
                            class="nav-link typography-nav"
                            data-active={isActive("/contact")}
                            >{nav.contact}</a
                        ><!-- Speaker Request -->
                        <a
                            href={l("/speaker-request")}
                            class="nav-link typography-nav"
                            data-active={isActive("/speaker-request")}
                            >{nav.speakerRequest}</a
                        >
                    </nav>

                    <!-- Language Switcher & Mobile Menu Container -->
                    <div class="flex items-center gap-2">
                        <!-- Language Switcher -->
                        <LanguageSwitcher />

                        <!-- Mobile menu button -->
                        <button
                            id="mobile-menu-button"
                            class="lg:hidden rounded-md p-2 text-gray-500 hover:text-[#006837] hover:bg-gray-100 transition-colors mobile-menu-toggle flex items-center justify-center h-9 w-9"
                            aria-label={currentLang === "en"
                                ? "Open menu"
                                : "メニューを開く"}
                            aria-expanded="false"
                            aria-controls="mobile-menu"
                        >
                            <svg
                                class="h-6 w-6 mobile-menu-icon"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    class="icon-hamburger"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16"></path>
                                <path
                                    class="icon-close"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2.5"
                                    d="M6 18L18 6M6 6l12 12"
                                ></path>
                            </svg>
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </header>

        <style>
            /* HEADER RESPONSIVE CSS */
            header {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 50 !important;
                height: 64px !important;
            }

            header > div:first-child {
                max-width: 1280px !important;
                margin: 0 auto !important;
                padding: 0 16px !important;
                height: 100% !important;
            }

            @media (min-width: 640px) {
                header > div:first-child {
                    padding: 0 24px !important;
                }
            }

            header > div:first-child > div:first-child {
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                height: 100% !important;
                gap: 8px !important;
            }

            @media (min-width: 1024px) {
                header > div:first-child > div:first-child {
                    gap: 16px !important;
                }
            }

            /* Logo styles */
            header a.flex-shrink-0 {
                display: inline-flex !important;
                align-items: center !important;
                height: 100% !important;
                flex-shrink: 0 !important;
            }

            header a.flex-shrink-0 span {
                font-size: 1.125rem !important;
                font-weight: 700 !important;
                white-space: nowrap !important;
            }

            @media (min-width: 1024px) {
                header a.flex-shrink-0 span {
                    font-size: 1.25rem !important;
                }
            }

            /* Desktop Navigation - show from lg (1024px) */
            @media (min-width: 1024px) {
                header nav {
                    display: flex !important;
                    align-items: center !important;
                    flex-wrap: nowrap !important;
                    gap: 16px !important;
                }
            }

            @media (min-width: 1280px) {
                header nav {
                    gap: 20px !important;
                }
            }

            header nav a,
            header nav .dropdown-button {
                font-size: 14px !important;
                font-weight: 500 !important;
                color: #4b5563 !important;
                transition:
                    color 0.2s ease !important,
                    opacity 0.2s ease !important;
                white-space: nowrap !important;
                line-height: 1.5 !important;
                height: 40px !important;
                display: inline-flex !important;
                align-items: center !important;
                padding: 0 4px !important;
            }

            header nav a:hover,
            header nav .dropdown-button:hover {
                color: #006837 !important;
            }

            /* Hover/active underline for nav */
            .nav-link {
                position: relative;
                padding-bottom: 6px !important;
            }

            .nav-link::after {
                content: "";
                position: absolute;
                left: 0;
                bottom: 0;
                height: 2px;
                width: 100%;
                background: linear-gradient(90deg, #006837, #00a855);
                transform: scaleX(0);
                transform-origin: left;
                transition: transform 0.24s cubic-bezier(0.33, 1, 0.68, 1);
            }

            .nav-link:hover::after {
                transform: scaleX(1);
            }

            .nav-link[data-active="true"] {
                color: #006837 !important;
                font-weight: 600 !important;
            }

            /* Header typography refinement */
            header .typography-nav {
                font-size: 0.875rem;
                font-weight: 500;
                letter-spacing: 0.05em;
            }

            header .nav-link[data-active="true"].typography-nav {
                font-weight: 600;
            }

            header .font-mincho-bold {
                font-weight: 600;
                letter-spacing: 0.05em;
            }

            /* Footer typography refinement */
            footer .font-mincho-bold {
                font-weight: 600;
                letter-spacing: 0.05em;
            }

            footer .typography-nav {
                font-size: 0.875rem;
                font-weight: 500;
                letter-spacing: 0.05em;
            }

            footer .typography-label {
                font-size: 0.75rem;
                font-weight: 600;
                letter-spacing: 0.08em;
            }

            .nav-link[data-active="true"]::after {
                transform: scaleX(1);
            }

            header nav .dropdown-button {
                display: inline-flex !important;
                align-items: center !important;
                gap: 6px !important;
            }

            @media (min-width: 1024px) {
                header nav .dropdown-button {
                    gap: 6px !important;
                }
            }

            /* Right side container (language switcher + mobile button) */
            header .flex.items-center.gap-2 {
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                flex-shrink: 0 !important;
            }

            @media (min-width: 1024px) {
                header .flex.items-center.gap-2 {
                    gap: 12px !important;
                }
            }


            header .dropdown-menu {
                z-index: 100 !important;
                position: absolute !important;
                left: 0 !important;
                top: 100% !important;
                margin-top: 4px !important;
                min-width: 180px !important;
                padding: 8px 0 !important;
                background-color: white !important;
                border-radius: 8px !important;
                box-shadow:
                    0 4px 6px -1px rgba(0, 0, 0, 0.1),
                    0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
                border: 1px solid #e5e7eb !important;
            }

            header .dropdown-menu a {
                display: block !important;
                padding: 10px 16px !important;
                font-size: 14px !important;
                color: #374151 !important;
            }

            header .dropdown-menu a:hover {
                background-color: #f3f4f6 !important;
                color: #006837 !important;
            }

            /* Dropdown container needs relative positioning */
            header .dropdown-container {
                position: relative !important;
            }
        </style>

        <!-- Mobile Menu Panel - Premium Glass Bottom Sheet Design -->
        <div
            id="mobile-menu"
            class="fixed left-0 right-0 bottom-0 top-16 z-40 opacity-0 pointer-events-none transition-opacity duration-200 ease-out lg:hidden"
            aria-hidden="true"
        >
            <!-- Backdrop -->
            <div class="absolute inset-0 mobile-menu-bg"></div>

            <!-- Content Container -->
            <div class="relative flex flex-col mobile-menu-panel">
                <!-- Header -->
                <div
                    class="mobile-menu-header"
                >
                    <div class="mobile-menu-header-inner">
                        <div class="mobile-menu-brand">
                            <div class="mobile-menu-badge">
                                <img
                                    src="/favicon.svg"
                                    alt="AIU Cedar Society"
                                    class="mobile-menu-badge-logo"
                                    width="22"
                                    height="22"
                                    loading="eager"
                                    decoding="async"
                                />
                            </div>
                            <div class="mobile-menu-brand-text">
                                <div class="mobile-menu-brand-title">
                                    AIU Cedar Society
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu Content -->
                <div
                    class="overflow-y-auto mobile-menu-content"
                >
                    <div
                        class="menu-section mobile-menu-grid-container"
                        style="--delay: 0;"
                    >
                        <nav
                            class="mobile-menu-grid"
                            aria-label={currentLang === "en" ? "Menu" : "メニュー"}
                        >
                            <a href={l("/about")} class="mobile-grid-item">
                                <div class="mobile-grid-title">
                                    {nav.aboutUs}
                                </div>
                            </a>
                            <a
                                href={l("/about/history")}
                                class="mobile-grid-item"
                            >
                                <div class="mobile-grid-title">
                                    {nav.history}
                                </div>
                            </a>
                            <a
                                href={l("/about/members")}
                                class="mobile-grid-item"
                            >
                                <div class="mobile-grid-title">
                                    {nav.members}
                                </div>
                            </a>
                            <a
                                href={l("/events/upcoming")}
                                class="mobile-grid-item"
                            >
                                <div class="mobile-grid-title">
                                    {nav.upcoming}
                                </div>
                            </a>
                            <a
                                href={l("/events/past")}
                                class="mobile-grid-item"
                            >
                                <div class="mobile-grid-title">
                                    {nav.past}
                                </div>
                            </a>
                            <a href={l("/media")} class="mobile-grid-item">
                                <div class="mobile-grid-title">
                                    {nav.media}
                                </div>
                            </a>
                            <a href={l("/faq")} class="mobile-grid-item">
                                <div class="mobile-grid-title">{nav.faq}</div>
                            </a>
                            <a
                                href={l("/sponsors")}
                                class="mobile-grid-item"
                            >
                                <div class="mobile-grid-title">
                                    {nav.sponsors}
                                </div>
                            </a>
                        </nav>
                    </div>
                </div>

                <!-- Footer Actions as Cards -->
                <div class="mobile-menu-footer">
                    <div
                        class="menu-section mobile-menu-actions-cards"
                        style="--delay: 1;"
                    >
                        <!-- Speaker Request Card -->
                        <a
                            href={l("/speaker-request")}
                            class="mobile-menu-action-card"
                        >
                            <div class="mobile-menu-action-content">
                                <div class="mobile-menu-action-title">{nav.speakerRequestMobile}</div>
                                <div class="mobile-menu-action-desc">
                                    {currentLang === "en" ? "Suggest a speaker" : "講演者を推薦する"}
                                </div>
                            </div>
                            <div class="mobile-menu-action-arrow">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </a>
                        
                        <!-- Contact Card -->
                        <a
                            href={l("/contact")}
                            class="mobile-menu-action-card"
                        >
                            <div class="mobile-menu-action-content">
                                <div class="mobile-menu-action-title">{nav.contactMobile}</div>
                                <div class="mobile-menu-action-desc">
                                    {currentLang === "en" ? "Get in touch with us" : "お気軽にご連絡ください"}
                                </div>
                            </div>
                            <div class="mobile-menu-action-arrow">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* Premium Mobile Menu Styles - Bottom Sheet */
            body.mobile-menu-open {
                overflow: hidden;
                /* Prevent layout shift when scrollbar disappears */
                padding-right: var(--scrollbar-comp, 0px);
            }

            /* Keep fixed header aligned when scrollbar compensation is applied */
            body.mobile-menu-open #site-header {
                padding-right: var(--scrollbar-comp, 0px) !important;
            }

            /* Keep fixed corner buttons aligned as well */
            body.mobile-menu-open #feedback-button {
                right: calc(1.5rem + var(--scrollbar-comp, 0px)) !important;
            }
            body.mobile-menu-open #back-to-top {
                right: calc(1.5rem + var(--scrollbar-comp, 0px)) !important;
            }

            /* Toggle icon (hamburger -> X) */
            #mobile-menu-button .mobile-menu-icon {
                display: block;
            }

            #mobile-menu-button .icon-close {
                opacity: 0;
                transform: scale(0.9) rotate(-45deg);
                transform-origin: center;
                transform-box: fill-box;
                transition:
                    opacity 180ms ease,
                    transform 220ms cubic-bezier(0.22, 1, 0.36, 1);
            }
            #mobile-menu-button .icon-hamburger {
                opacity: 1;
                transform: scale(1) rotate(0deg);
                transform-origin: center;
                transform-box: fill-box;
                transition:
                    opacity 160ms ease,
                    transform 220ms cubic-bezier(0.22, 1, 0.36, 1);
            }
            #mobile-menu-button.is-open .icon-close {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            #mobile-menu-button.is-open .icon-hamburger {
                opacity: 0;
                transform: scale(0.9) rotate(45deg);
            }

            /* Make the close (X) icon green when open */
            #mobile-menu-button.is-open {
                color: #006837 !important;
            }

            /* Open/close */
            #mobile-menu.is-open {
                opacity: 1;
                pointer-events: auto;
            }

            .mobile-menu-bg {
                background: rgba(0, 0, 0, 0.35);
                backdrop-filter: blur(18px) saturate(140%);
                -webkit-backdrop-filter: blur(18px) saturate(140%);
                opacity: 0;
                transition: opacity 0.25s ease-out;
            }

            #mobile-menu.is-open .mobile-menu-bg {
                opacity: 1;
            }

            .mobile-menu-panel {
                position: absolute;
                left: 0;
                right: 0;
                top: 0;
                max-height: 85vh;
                background: linear-gradient(
                    145deg,
                    rgba(255, 255, 255, 0.98),
                    rgba(249, 250, 251, 0.98)
                );
                border-radius: 0 0 24px 24px;
                box-shadow:
                    0 18px 50px rgba(15, 23, 42, 0.25),
                    0 1px 0 rgba(255, 255, 255, 0.6) inset;
                transform: translateY(-14px);
                opacity: 0;
                transition:
                    transform 0.25s cubic-bezier(0.22, 1, 0.36, 1),
                    opacity 0.2s ease-out;
                overflow: auto;
            }

            #mobile-menu.is-open .mobile-menu-panel {
                transform: translateY(0);
                opacity: 1;
            }

            /* iPadサイズ（768px以上、1024px未満）では右側からスライドインするサイドバー形式 */
            @media (min-width: 768px) and (max-width: 1023px) {
                .mobile-menu-panel {
                    left: auto;
                    right: 0;
                    width: 66.67%;
                    max-width: 600px;
                    border-radius: 24px 0 0 24px;
                    transform: translateX(100%);
                    transition:
                        transform 0.3s cubic-bezier(0.22, 1, 0.36, 1),
                        opacity 0.2s ease-out;
                }

                #mobile-menu.is-open .mobile-menu-panel {
                    transform: translateX(0);
                }
            }

            .mobile-menu-header {
                padding: 18px 20px 12px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.06);
                background: linear-gradient(
                    to bottom,
                    rgba(255, 255, 255, 0.7),
                    rgba(255, 255, 255, 0.2)
                );
            }

            .mobile-menu-footer {
                padding: 20px 20px 24px;
                background: transparent;
            }

            .mobile-menu-header-inner {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                transition:
                    opacity 220ms ease,
                    transform 260ms cubic-bezier(0.16, 1, 0.3, 1);
            }

            .mobile-menu-brand {
                display: flex;
                align-items: center;
                gap: 12px;
                min-width: 0;
            }

            .mobile-menu-badge {
                width: 40px;
                height: 40px;
                border-radius: 14px;
                display: grid;
                place-items: center;
                background: rgba(255, 255, 255, 0.92);
                border: 1px solid rgba(0, 0, 0, 0.06);
                box-shadow:
                    0 10px 24px rgba(17, 24, 39, 0.08),
                    0 1px 0 rgba(255, 255, 255, 0.7) inset;
                flex-shrink: 0;
            }

            .mobile-menu-badge-logo {
                width: 22px;
                height: 22px;
                display: block;
            }

            .mobile-menu-brand-title {
                font-family: var(--font-mincho);
                font-size: 16px;
                font-weight: 600;
                color: #111827;
                letter-spacing: 0.05em;
                line-height: 1.2;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .mobile-menu-brand-subtitle {
                margin-top: 2px;
                font-size: 12px;
                font-weight: 600;
                color: rgba(75, 85, 99, 0.9);
                letter-spacing: 0.08em;
                text-transform: uppercase;
            }

            /* (removed) in-menu close button */

            .mobile-menu-inner {
                padding: 16px 20px 20px;
            }

            .mobile-menu-group-title {
                font-family: var(--font-geometric);
                font-size: 12px;
                font-weight: 800;
                color: rgba(107, 114, 128, 0.9);
                letter-spacing: 0.16em;
                text-transform: uppercase;
                margin: 18px 2px 10px;
            }

            .mobile-menu-list {
                display: grid;
                gap: 10px;
            }

            .mobile-menu-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                padding: 14px 14px;
                border-radius: 16px;
                background: rgba(255, 255, 255, 0.78);
                border: 1px solid rgba(0, 0, 0, 0.06);
                box-shadow: 0 10px 26px rgba(17, 24, 39, 0.05);
                text-decoration: none;
                transition:
                    transform 180ms ease,
                    border-color 180ms ease,
                    box-shadow 180ms ease;
                min-height: 56px;
            }

            .mobile-menu-item:active {
                transform: scale(0.99);
            }

            .mobile-menu-item-main {
                min-width: 0;
            }

            .mobile-menu-item-title {
                font-family: var(--font-geometric);
                font-size: 15px;
                font-weight: 600;
                color: #111827;
                letter-spacing: var(--letter-spacing-wide);
                line-height: 1.2;
            }

            .mobile-menu-item-desc {
                margin-top: 4px;
                font-size: 12px;
                color: #6b7280;
                line-height: 1.4;
            }

            .mobile-menu-item-arrow {
                width: 28px;
                height: 28px;
                border-radius: 9999px;
                display: grid;
                place-items: center;
                background: rgba(0, 104, 55, 0.08);
                color: #006837;
                flex-shrink: 0;
            }

            .mobile-menu-item-arrow-icon {
                width: 16px;
                height: 16px;
                display: block;
            }

            .mobile-menu-cta {
                display: block;
                padding: 18px 16px;
                border-radius: 18px;
                background: linear-gradient(135deg, #006837 0%, #00a855 100%);
                color: #fff;
                text-decoration: none;
                box-shadow:
                    0 18px 40px rgba(0, 104, 55, 0.28),
                    0 0 0 1px rgba(255, 255, 255, 0.18) inset;
            }

            .mobile-menu-cta-title {
                font-weight: 900;
                letter-spacing: -0.01em;
                font-size: 16px;
                line-height: 1.2;
            }

            .mobile-menu-cta-desc {
                margin-top: 6px;
                font-size: 12px;
                line-height: 1.5;
                opacity: 0.92;
            }

            .mobile-menu-footer-text {
                font-family: var(--font-geometric);
                text-align: center;
                font-size: 12px;
                font-weight: 600;
                color: rgba(107, 114, 128, 0.9);
                letter-spacing: 0.08em;
                text-transform: uppercase;
            }

            /* Menu section animation */
            .menu-section {
                opacity: 0;
                transform: translateY(10px);
                transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
                transition-delay: 0s;
            }

            #mobile-menu.is-open .menu-section {
                opacity: 1;
                transform: translateY(0);
                transition-delay: calc(var(--delay) * 0.1s);
            }

            /* Reverse stagger on close */
            #mobile-menu {
                --menu-stagger-count: 1; /* max --delay used in markup */
            }

            #mobile-menu.is-closing .menu-section {
                opacity: 0;
                transform: translateY(10px);
                transition-delay: calc(
                    (var(--menu-stagger-count, 1) - var(--delay)) * 0.1s
                );
            }

            /* Fade out header (logo area) near the end of close to avoid “hitch” */
            #mobile-menu.is-closing .mobile-menu-header-inner {
                opacity: 0;
                transform: translateY(-6px);
                transition-delay: 420ms;
            }

            /* Scrollbar styling */
            .mobile-menu-content::-webkit-scrollbar {
                width: 4px;
            }

            .mobile-menu-content::-webkit-scrollbar-track {
                background: transparent;
            }

            .mobile-menu-content::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.1);
                border-radius: 4px;
            }

            .mobile-menu-content::-webkit-scrollbar-thumb:hover {
                background: rgba(0, 0, 0, 0.2);
            }

            /* Mobile menu compact grid override */
            .mobile-menu-content {
                padding: 12px 14px 16px;
            }

            .menu-section {
                margin: 0;
                padding: 0;
            }

            .mobile-menu-grid {
                display: grid;
                gap: 14px;
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }

            .mobile-grid-item {
                position: relative;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                min-width: 0;
                min-height: 68px;
                padding: 14px;
                border-radius: 16px;
                background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.92),
                    rgba(245, 248, 250, 0.9)
                );
                border: 1px solid rgba(0, 104, 55, 0.08);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
                box-shadow:
                    0 12px 28px rgba(17, 24, 39, 0.08),
                    0 1px 0 rgba(255, 255, 255, 0.85) inset;
                text-decoration: none;
                transition:
                    transform 180ms ease,
                    border-color 180ms ease,
                    box-shadow 180ms ease,
                    background 180ms ease;
            }

            .mobile-grid-item::before {
                content: "";
                position: absolute;
                inset: 0;
                border-radius: inherit;
                background: linear-gradient(
                    135deg,
                    rgba(0, 104, 55, 0.16),
                    rgba(0, 168, 85, 0.1)
                );
                opacity: 0;
                transition: opacity 180ms ease;
                pointer-events: none;
            }

            .mobile-grid-item:hover,
            .mobile-grid-item:focus-visible {
                transform: translateY(-2px);
                border-color: rgba(0, 104, 55, 0.2);
                box-shadow:
                    0 16px 36px rgba(17, 24, 39, 0.1),
                    0 1px 0 rgba(255, 255, 255, 0.92) inset;
            }

            .mobile-grid-item:hover::before,
            .mobile-grid-item:focus-visible::before {
                opacity: 1;
            }

            .mobile-grid-item:active {
                transform: translateY(0);
            }

            .mobile-grid-item:focus-visible {
                outline: 2px solid rgba(0, 104, 55, 0.28);
                outline-offset: 2px;
            }

            .mobile-grid-title {
                font-family: var(--font-geometric);
                /* サイト全体のナビ（typography-nav / text-sm）に合わせる */
                font-size: 14px;
                font-weight: 500;
                color: #111827;
                letter-spacing: var(--letter-spacing-wide);
                line-height: 1.3;
                min-width: 0;
                white-space: nowrap;
                text-align: center;
            }

            .mobile-grid-desc {
                /* サブタイトルは使わない（残っていても表示しない） */
                display: none;
                font-size: 12px;
                color: #6b7280;
                line-height: 1.4;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* Footer actions (full-width CTAs) */
            .mobile-menu-footer {
                padding: 12px 14px 16px;
            }

            .mobile-menu-actions {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            .mobile-menu-cta-primary,
            .mobile-menu-cta-secondary {
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                min-height: 52px;
                padding: 14px;
                border-radius: 16px;
                font-family: var(--font-geometric);
                font-weight: 800;
                text-decoration: none;
                transition:
                    transform 180ms ease,
                    box-shadow 180ms ease;
                outline: none;

            .mobile-menu-cta-primary::before,
            .mobile-menu-cta-secondary::before {
                content: "";
                position: absolute;
                inset: 0;
                border-radius: inherit;
                opacity: 0;
                transition: opacity 180ms ease;
                pointer-events: none;
            }

            .mobile-menu-cta-primary {
                background: linear-gradient(135deg, #006837 0%, #00a855 100%);
                color: #fff;
                box-shadow:
                    0 18px 40px rgba(0, 104, 55, 0.26),
                    0 0 0 1px rgba(255, 255, 255, 0.18) inset;
            }

            .mobile-menu-cta-primary::before {
                background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.18),
                    rgba(255, 255, 255, 0)
                );
            }

            .mobile-menu-cta-secondary {
                background: linear-gradient(
                    135deg,
                    rgba(255, 255, 255, 0.95),
                    rgba(240, 253, 244, 0.9)
                );
                color: #006837;
                border: 1.5px solid rgba(0, 104, 55, 0.25);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
                box-shadow:
                    0 12px 28px rgba(17, 24, 39, 0.08),
                    0 1px 0 rgba(255, 255, 255, 0.85) inset;
            }

            .mobile-menu-cta-secondary::before {
                background: linear-gradient(
                    135deg,
                    rgba(0, 104, 55, 0.12),
                    rgba(0, 168, 85, 0.08)
                );
            }

            .mobile-menu-cta-primary:hover,
            .mobile-menu-cta-primary:focus-visible,
            .mobile-menu-cta-secondary:hover,
            .mobile-menu-cta-secondary:focus-visible {
                transform: translateY(-2px);
                box-shadow:
                    0 16px 36px rgba(17, 24, 39, 0.1),
                    0 1px 0 rgba(255, 255, 255, 0.92) inset;
            }

            .mobile-menu-cta-primary:hover::before,
            .mobile-menu-cta-primary:focus-visible::before,
            .mobile-menu-cta-secondary:hover::before,
            .mobile-menu-cta-secondary:focus-visible::before {
                opacity: 1;
            }

            .mobile-menu-cta-primary:active,
            .mobile-menu-cta-secondary:active {
                transform: translateY(0);
            }

            .mobile-menu-cta-primary:focus-visible,
            .mobile-menu-cta-secondary:focus-visible {
                outline: 2px solid rgba(0, 104, 55, 0.28);
                outline-offset: 2px;
            }

            @media (max-width: 360px) {
                .mobile-menu-content {
                    padding: 10px 12px 14px;
                }

                .mobile-menu-grid {
                    gap: 12px;
                    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                }

                .mobile-grid-item {
                    min-height: 64px;
                    padding: 12px;
                }

                .mobile-menu-footer {
                    padding: 10px 12px 14px;
                }

                .mobile-menu-cta-primary,
                .mobile-menu-cta-secondary {
                    min-height: 50px;
                    padding: 12px;
                }
            }
        </style>

        <style>
            /* Mobile menu action cards */
            .mobile-menu-actions-cards {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .mobile-menu-action-card {
                display: flex;
                align-items: center;
                gap: 14px;
                padding: 16px;
                border-radius: 16px;
                text-decoration: none;
                transition: transform 180ms ease, box-shadow 180ms ease;
                background: rgba(255, 255, 255, 0.9);
                border: 1px solid rgba(0, 0, 0, 0.08);
                box-shadow: 0 8px 20px rgba(17, 24, 39, 0.08);
            }

            .mobile-menu-action-card:active {
                transform: scale(0.98);
            }

            .mobile-menu-action-content {
                flex: 1;
                min-width: 0;
            }

            .mobile-menu-action-title {
                font-family: var(--font-geometric);
                font-size: 15px;
                font-weight: 700;
                line-height: 1.3;
                color: #111827;
            }

            .mobile-menu-action-desc {
                font-size: 12px;
                line-height: 1.4;
                margin-top: 2px;
                color: #6b7280;
            }

            .mobile-menu-action-arrow {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                background: rgba(0, 104, 55, 0.08);
                color: #006837;
            }

            /* Japanese font weight adjustments for mobile menu */
            :lang(ja) .mobile-menu-item-title {
                font-weight: 700;
            }

            :lang(ja) .mobile-menu-cta-primary,
            :lang(ja) .mobile-menu-cta-secondary {
                font-weight: 900;
            }

            :lang(ja) .mobile-grid-title {
                font-weight: 700;
            }

            :lang(ja) .mobile-menu-action-title {
                font-weight: 800;
            }
        </style>

        <!-- Main Content -->
        <main class="flex-grow pt-16 relative z-10" id="top">
            <slot />
        </main>
        <footer
            id="site-footer"
            class="relative z-10 site-footer"
        >
            <div style="max-width: 800px; margin: 0 auto; text-align: center;">
                <!-- Title -->
                <p
                    class="font-mincho-bold"
                    style="color: #111827; font-weight: 600; font-size: 1.25rem; margin-bottom: 12px; letter-spacing: 0.05em; white-space: nowrap;"
                >
                    AIU Cedar Society
                </p>
                <!-- Description -->
                <p
                    style="color: #4b5563; font-size: 0.875rem; line-height: 1.6; margin-bottom: 40px; font-family: var(--font-geometric);"
                >
                    {
                        currentLang === "en"
                            ? "An officially recognized student-led organization at Akita International University. We connect students and Akita society through lectures featuring distinguished guests."
                            : "秋田国際教養大学の学生主導の公認団体。著名なゲストを招いた講演会を通じて、学生と秋田社会をつなぎます。"
                    }
                </p>

                <!-- Instagram Card -->
                <div
                    style="display: flex; justify-content: center; margin-bottom: 40px;"
                >
                    <a
                        href="https://www.instagram.com/aiucedarsociety"
                        target="_blank"
                        rel="noopener noreferrer"
                        style="display: inline-flex; align-items: center; gap: 16px; padding: 16px 24px; background: white; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-decoration: none; transition: all 0.3s ease;"
                        class="hover:shadow-md hover:border-gray-300"
                    >
                        <!-- Icon Box -->
                        <div
                            style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);"
                        >
                            <svg
                                style="width: 24px; height: 24px; color: white;"
                                fill="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"
                                ></path>
                            </svg>
                        </div>
                        <!-- Text -->
                        <div style="text-align: left;">
                            <p
                                class="typography-label"
                                style="color: #6b7280; font-size: 0.75rem; margin-bottom: 2px;"
                            >
                                Follow us on Instagram
                            </p>
                            <p
                                class="typography-nav"
                                style="color: #111827; font-weight: 600; font-size: 1rem;"
                            >
                                @aiucedarsociety
                            </p>
                        </div>
                        <!-- Arrow -->
                        <svg
                            style="width: 20px; height: 20px; color: #9ca3af;"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>

                <!-- Newsletter Signup -->
                <div
                    style="display: flex; justify-content: center; margin-bottom: 40px;"
                >
                    <div
                        style="width: 100%; max-width: 640px; padding: 18px 20px; background: white; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
                    >
                        <div style="text-align: left;">
                            <p
                                class="typography-label"
                                style="color: #6b7280; font-size: 0.75rem; margin-bottom: 2px;"
                            >
                                { currentLang === "en" ? "Newsletter" : "ニュースレター" }
                            </p>
                            <p
                                class="typography-nav"
                                style="color: #111827; font-weight: 600; font-size: 1rem; margin-bottom: 12px;"
                            >
                                {
                                    currentLang === "en"
                                        ? "Get updates on upcoming events and news."
                                        : "最新のイベント情報やニュースをメールで受け取れます。"
                                }
                            </p>
                        </div>
                        <div class="ml-embedded" data-form="deWg8R"></div>
                    </div>
                </div>

                <!-- AIU Official Link -->
                <div
                    style="display: flex; justify-content: center; margin-bottom: 32px;"
                >
                    <a
                        href="https://web.aiu.ac.jp/"
                        target="_blank"
                        rel="noopener noreferrer"
                        style="display: inline-flex; align-items: center; gap: 12px; padding: 12px 20px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; text-decoration: none; transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.05);"
                        class="hover:shadow-md hover:border-gray-300"
                    >
                        <svg
                            style="width: 20px; height: 20px; color: #6b7280;"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                            ></path>
                        </svg>
                        <span
                            class="typography-nav"
                            style="color: #374151; font-size: 0.875rem; font-weight: 600;"
                        >
                            {
                                currentLang === "en"
                                    ? "Akita International University (Official)"
                                    : "国際教養大学（公式サイト）"
                            }
                        </span>
                        <svg
                            style="width: 16px; height: 16px; color: #9ca3af;"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                            ></path>
                        </svg>
                    </a>
                </div>

                <!-- Navigation Links -->
                <div
                    style="display: flex; flex-wrap: wrap; justify-content: center; gap: 24px; margin-bottom: 32px;"
                >
                    <a
                        href={l("/about")}
                        style="color: #6b7280; font-size: 0.75rem; text-decoration: none;"
                        class="typography-nav hover:text-[#006837]">About</a
                    >
                    <a
                        href={l("/events/upcoming")}
                        style="color: #6b7280; font-size: 0.75rem; text-decoration: none;"
                        class="typography-nav hover:text-[#006837]">Events</a
                    >
                    <a
                        href={l("/media")}
                        style="color: #6b7280; font-size: 0.75rem; text-decoration: none;"
                        class="typography-nav hover:text-[#006837]">Media</a
                    >
                    <a
                        href={l("/faq")}
                        style="color: #6b7280; font-size: 0.75rem; text-decoration: none;"
                        class="typography-nav hover:text-[#006837]">FAQ</a
                    >
                    <a
                        href={l("/sponsors")}
                        style="color: #6b7280; font-size: 0.75rem; text-decoration: none;"
                        class="typography-nav hover:text-[#006837]">Sponsors</a
                    >
                    <a
                        href={l("/contact")}
                        style="color: #6b7280; font-size: 0.75rem; text-decoration: none;"
                        class="typography-nav hover:text-[#006837]">Contact</a
                    >
                    <a
                        href={l("/speaker-request")}
                        style="color: #6b7280; font-size: 0.75rem; text-decoration: none;"
                        class="typography-nav hover:text-[#006837]">Request</a
                    >
                </div>

                <!-- Copyright -->
                <div style="padding-top: 24px; border-top: 1px solid #e5e7eb;">
                    <p
                        class="typography-label"
                        style="color: #6b7280; font-size: 0.75rem; letter-spacing: 0.025em; text-align: center;"
                    >
                        &copy; {new Date().getFullYear()} <span style="white-space: nowrap;">AIU Cedar Society</span>
                    </p>
                </div>
            </div>
        </footer>

        <!-- Back to Top Button -->
        <a
            href="#top"
            id="back-to-top"
            title="トップに戻る"
            style="position: fixed !important; bottom: 1.5rem !important; right: 1.5rem !important; z-index: 50 !important;"
            class="w-12 h-12 bg-[#006837] text-white rounded-full flex items-center justify-center opacity-0 invisible transition-all duration-300 hover:bg-[#005028] shadow-lg hover:shadow-xl relative overflow-hidden"
            aria-label="トップに戻る"
        >
            <span
                class="absolute inset-0 rounded-full pointer-events-none progress-ring"
                aria-hidden="true"
            ></span>
            <svg
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2.5"
                    d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
            </svg>
        </a>

        <!-- Lightweight page loading indicator -->
        <div
            id="page-loading-indicator"
            class="fixed bottom-4 left-4 z-[60] pointer-events-none opacity-0 translate-y-2 transition-all duration-150 bg-black/70 text-white text-xs font-medium px-3 py-2 rounded-full flex items-center gap-2 shadow-lg"
            role="status"
            aria-live="polite"
        >
            <svg
                class="w-4 h-4 animate-spin text-white"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
            >
                <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                ></circle>
                <path
                    class="opacity-75"
                    d="M4 12a8 8 0 018-8"
                    stroke="currentColor"
                    stroke-linecap="round"
                ></path>
            </svg>
            <span>読み込み中...</span>
        </div>

        <!-- Toast container (required for window.showToast) -->
        <div
            id="toast-container"
            class="toast-container"
            aria-live="polite"
            aria-relevant="additions text"
        ></div>

        <!-- Form Result Modal (center popup) -->
        <div id="form-modal" class="form-modal hidden" aria-hidden="true">
            <div
                id="form-modal-backdrop"
                class="form-modal-backdrop"
                data-form-modal-close
                aria-hidden="true"
            ></div>
            <div
                class="form-modal-panel"
                role="dialog"
                aria-modal="true"
                aria-labelledby="form-modal-title"
                aria-describedby="form-modal-message"
            >
                <div class="form-modal-header">
                    <div class="form-modal-icon" aria-hidden="true">✓</div>
                    <button
                        id="form-modal-close"
                        class="form-modal-close"
                        type="button"
                        data-form-modal-close
                        aria-label={currentLang === "en" ? "Close" : "閉じる"}
                    >
                        ×
                    </button>
                </div>
                <h3 id="form-modal-title" class="form-modal-title">
                    送信が完了しました
                </h3>
                <p id="form-modal-message" class="form-modal-message">
                    送信が完了しました。ありがとうございます。
                </p>
                <div class="form-modal-actions">
                    <button
                        id="form-modal-ok"
                        class="form-modal-ok"
                        type="button"
                        data-form-modal-close
                    >
                        OK
                    </button>
                </div>
            </div>
        </div>

        <!-- Ensure modal API exists even if other large inline scripts fail -->
        <script is:inline>
            (function () {
                // ---------------------------
                // Toast API (safe fallback)
                // ---------------------------
                if (typeof window.showToast !== "function") {
                    window.showToast = function (message, type = "success") {
                        const container =
                            document.getElementById("toast-container");
                        if (!container) return;

                        const toast = document.createElement("div");
                        toast.className = `toast toast-${type}`;
                        toast.setAttribute("role", "alert");
                        toast.setAttribute("aria-live", "polite");

                        const icons = {
                            success: "✓",
                            error: "✕",
                            info: "ℹ",
                        };

                        toast.innerHTML = `
                            <div class="toast-icon" style="color: ${
                                type === "success"
                                    ? "#10b981"
                                    : type === "error"
                                        ? "#ef4444"
                                        : "#3b82f6"
                            }; font-size: 18px; font-weight: bold;">
                                ${icons[type] || icons.info}
                            </div>
                            <div class="toast-message">${message}</div>
                        `;

                        container.appendChild(toast);
                        setTimeout(() => toast.classList.add("show"), 50);
                        setTimeout(() => {
                            toast.classList.remove("show");
                            setTimeout(() => toast.remove(), 250);
                        }, 3000);
                    };
                }

                // ---------------------------
                // Form modal API (guaranteed)
                // ---------------------------
                if (typeof window.showFormModal === "function") return;

                function isOpen() {
                    const modal = document.getElementById("form-modal");
                    return modal && !modal.classList.contains("hidden");
                }

                function open(title, message, type) {
                    const modal = document.getElementById("form-modal");
                    const titleEl = document.getElementById("form-modal-title");
                    const messageEl =
                        document.getElementById("form-modal-message");
                    const okBtn = document.getElementById("form-modal-ok");

                    if (!modal || !titleEl || !messageEl) return;

                    const active = document.activeElement;
                    document.body.dataset.formModalReturnFocus =
                        active && active.id ? active.id : "";

                    modal.setAttribute("data-type", type || "success");
                    titleEl.textContent = title || "送信が完了しました";
                    messageEl.textContent =
                        message || "送信が完了しました。ありがとうございます。";

                    modal.classList.remove("hidden");
                    modal.setAttribute("aria-hidden", "false");
                    document.body.classList.add("form-modal-open");

                    setTimeout(() => {
                        okBtn?.focus?.({ preventScroll: true });
                    }, 0);
                }

                function close() {
                    const modal = document.getElementById("form-modal");
                    if (!modal) return;
                    modal.classList.add("hidden");
                    modal.setAttribute("aria-hidden", "true");
                    document.body.classList.remove("form-modal-open");

                    const returnId = document.body.dataset.formModalReturnFocus;
                    if (returnId) {
                        document
                            .getElementById(returnId)
                            ?.focus?.({ preventScroll: true });
                    }
                    document.body.dataset.formModalReturnFocus = "";
                }

                window.showFormModal = function (
                    title,
                    message,
                    type = "success",
                ) {
                    open(title, message, type);
                };
                window.hideFormModal = close;

                if (window.__formModalDelegated) return;
                window.__formModalDelegated = true;

                document.addEventListener("click", (e) => {
                    const t = e.target;
                    const closeEl = t?.closest?.("[data-form-modal-close]");
                    if (closeEl) {
                        e.preventDefault();
                        close();
                    }
                });

                document.addEventListener("keydown", (e) => {
                    if (!isOpen()) return;
                    if (e.key === "Escape") {
                        e.preventDefault();
                        close();
                    }
                });
            })();
        </script>

        <style>
            /* Back to Top - progress ring */
            #back-to-top .progress-ring {
                background: conic-gradient(
                    rgba(255, 255, 255, 0.25) calc(var(--scroll-progress, 0) * 1%),
                    rgba(255, 255, 255, 0.08) 0
                );
                transition: background 120ms ease;
            }
            #back-to-top::after {
                content: attr(title);
                position: absolute;
                bottom: 110%;
                right: 50%;
                transform: translateX(50%);
                background: rgba(0, 0, 0, 0.75);
                color: white;
                padding: 6px 8px;
                border-radius: 6px;
                font-size: 11px;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.15s ease;
                white-space: nowrap;
            }
            #back-to-top:hover::after {
                opacity: 1;
            }
        </style>

        <style>
            /* ===== Form Modal Styles ===== */
            body.form-modal-open {
                overflow: hidden;
            }

            .form-modal.hidden {
                display: none;
            }

            .form-modal {
                position: fixed;
                inset: 0;
                z-index: 100000;
                display: grid;
                place-items: center;
                padding: 24px;
            }

            .form-modal-backdrop {
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.45);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }

            .form-modal-panel {
                position: relative;
                width: min(560px, calc(100vw - 48px));
                border-radius: 16px;
                background: #ffffff;
                border: 1px solid rgba(0, 0, 0, 0.06);
                box-shadow:
                    0 24px 64px rgba(0, 0, 0, 0.25),
                    0 0 0 1px rgba(0, 0, 0, 0.05);
                padding: 22px 22px 18px;
                transform: translateY(0);
                animation: form-modal-in 180ms cubic-bezier(0.16, 1, 0.3, 1);
            }

            @keyframes form-modal-in {
                from {
                    opacity: 0;
                    transform: translateY(10px) scale(0.98);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .form-modal-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                margin-bottom: 10px;
            }

            .form-modal-icon {
                width: 36px;
                height: 36px;
                border-radius: 12px;
                display: grid;
                place-items: center;
                background: rgba(0, 104, 55, 0.12);
                color: #006837;
                font-weight: 800;
                font-size: 18px;
            }

            .form-modal-close {
                width: 40px;
                height: 40px;
                border-radius: 12px;
                background: rgba(0, 0, 0, 0.05);
                border: 1px solid rgba(0, 0, 0, 0.08);
                color: rgba(0, 0, 0, 0.55);
                font-size: 22px;
                line-height: 1;
                cursor: pointer;
                transition: background 150ms ease, transform 150ms ease;
            }
            .form-modal-close:hover {
                background: rgba(0, 0, 0, 0.08);
                transform: rotate(90deg);
            }

            .form-modal-title {
                margin: 0 0 6px;
                font-size: 1.25rem;
                line-height: 1.3;
                font-weight: 800;
                color: #111827;
                letter-spacing: -0.01em;
            }

            .form-modal-message {
                margin: 0;
                color: #4b5563;
                line-height: 1.7;
                font-size: 0.95rem;
            }

            .form-modal-actions {
                display: flex;
                justify-content: flex-end;
                margin-top: 16px;
            }

            .form-modal-ok {
                min-height: 44px;
                padding: 10px 16px;
                border-radius: 12px;
                background: linear-gradient(135deg, #006837, #00a855);
                color: white;
                font-weight: 700;
                border: none;
                cursor: pointer;
                box-shadow: 0 6px 16px rgba(0, 104, 55, 0.25);
                transition: transform 150ms ease, box-shadow 150ms ease;
            }
            .form-modal-ok:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 22px rgba(0, 104, 55, 0.32);
            }

            [data-theme="dark"] .form-modal-panel {
                background: #111827;
                border-color: rgba(255, 255, 255, 0.08);
            }
            [data-theme="dark"] .form-modal-title {
                color: #f9fafb;
            }
            [data-theme="dark"] .form-modal-message {
                color: #d1d5db;
            }
            [data-theme="dark"] .form-modal-close {
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.12);
                color: rgba(255, 255, 255, 0.75);
            }

            @media (prefers-reduced-motion: reduce) {
                .form-modal-panel {
                    animation: none;
                }
                .form-modal-close:hover {
                    transform: none;
                }
                .form-modal-ok:hover {
                    transform: none;
                }
            }
        </style>

        <!-- Performance Optimization Scripts -->
        <script>
            import { setupLazyLoading } from "../utils/lazyLoad";
            import { measureWebVitals } from "../utils/webVitals";

            // Initialize on page load (View Transitions compatible)
            document.addEventListener("astro:page-load", () => {
                setupLazyLoading();
                measureWebVitals();
            });
        </script>
    </body>
</html>

<style>
    :root {
        --font-sans: "Noto Sans JP", "Noto Sans JP Fallback", sans-serif;
        --color-aiu-green: #006837;
    }
    html {
        font-family: var(--font-sans);
        /* Japanese text line break control */
        word-break: keep-all;
        overflow-wrap: break-word;
        hyphens: none;
    }
    
    body {
        /* Japanese text line break control */
        word-break: keep-all;
        overflow-wrap: break-word;
        hyphens: none;
        line-break: strict;
    }

    /* Desktop hover support */
    @media (hover: hover) {
        .dropdown-container:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
        }
        .dropdown-container:hover .dropdown-icon {
            transform: rotate(180deg);
        }
    }

    /* Active dropdown state */
    .dropdown-container.active .dropdown-menu {
        opacity: 1;
        visibility: visible;
    }
    .dropdown-container.active .dropdown-icon {
        transform: rotate(180deg);
    }
</style>

<script is:inline>
    // Mobile Menu Toggle
    function initMobileMenu() {
        const menuButton = document.getElementById("mobile-menu-button");
        const mobileMenu = document.getElementById("mobile-menu");

        if (!menuButton || !mobileMenu) {
            console.log("Mobile menu elements not found");
            return;
        }

        // Remove any existing click handlers by cloning nodes
        const newMenuButton = menuButton.cloneNode(true);
        menuButton.parentNode?.replaceChild(newMenuButton, menuButton);

        // Get fresh references
        const freshMenuButton = document.getElementById("mobile-menu-button");
        const freshMobileMenu = document.getElementById("mobile-menu");
        let closeStageTimer = null;
        let closeFinalizeTimer = null;

        function isOpen() {
            return !!freshMobileMenu?.classList.contains("is-open");
        }

        function openMenu() {
            if (closeStageTimer) {
                clearTimeout(closeStageTimer);
                closeStageTimer = null;
            }
            if (closeFinalizeTimer) {
                clearTimeout(closeFinalizeTimer);
                closeFinalizeTimer = null;
            }
            if (freshMobileMenu) {
                freshMobileMenu.classList.remove("is-closing");
                freshMobileMenu.classList.add("is-open");
                freshMobileMenu.setAttribute("aria-hidden", "false");
            }
            // Compensate for scrollbar width to avoid layout shift
            const scrollbarWidth = Math.max(
                0,
                window.innerWidth - document.documentElement.clientWidth,
            );
            document.documentElement.style.setProperty(
                "--scrollbar-comp",
                `${scrollbarWidth}px`,
            );
            document.body.classList.add("mobile-menu-open");
            if (freshMenuButton) {
                freshMenuButton.classList.add("is-open");
                    freshMenuButton.setAttribute("aria-expanded", "true");
                freshMenuButton.setAttribute(
                    "aria-label",
                    document.documentElement.lang === "en"
                        ? "Close menu"
                        : "メニューを閉じる",
                );
            }
        }

        function closeMenu() {
            if (closeStageTimer || closeFinalizeTimer) return; // already closing
            if (freshMobileMenu) {
                // play reverse stagger animation first
                freshMobileMenu.classList.add("is-closing");
            }

            // Match open/close total duration (shorter), while keeping a hint of reverse-stagger.
            // CSS timings:
            // - menu-section: 0.35s + max delay 0.1s => 0.45s total
            // - panel/backdrop: ~0.25s
            // Start panel fade slightly after close begins so everything ends together (~0.45s).
            const closeStageMs = 200; // when to start panel/backdrop fade
            const closeTotalMs = 450; // total close duration

            closeStageTimer = setTimeout(() => {
                closeStageTimer = null;
                // start panel/backdrop fade
                freshMobileMenu?.classList.remove("is-open");
            }, closeStageMs);

            closeFinalizeTimer = setTimeout(() => {
                closeFinalizeTimer = null;
                if (freshMobileMenu) {
                    freshMobileMenu.classList.remove("is-closing");
                    freshMobileMenu.setAttribute("aria-hidden", "true");
                }
                document.body.classList.remove("mobile-menu-open");
                document.documentElement.style.setProperty(
                    "--scrollbar-comp",
                    "0px",
                );
                if (freshMenuButton) {
                    freshMenuButton.classList.remove("is-open");
                    freshMenuButton.setAttribute("aria-expanded", "false");
                    freshMenuButton.setAttribute(
                        "aria-label",
                        document.documentElement.lang === "en"
                            ? "Open menu"
                            : "メニューを開く",
                    );
                }
            }, closeTotalMs);
        }

        function toggleMenu() {
            if (isOpen()) closeMenu();
            else openMenu();
        }

        // Event listeners
        if (freshMenuButton) {
            freshMenuButton.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleMenu();
            });
            console.log("Mobile menu button listener attached");
        }

        // Close menu on link click - instant close for faster navigation
        const menuLinks = freshMobileMenu?.querySelectorAll("a");
        menuLinks?.forEach((link) => {
            link.addEventListener("click", () => {
                closeMenu(); // Instant close, no delay
            });
        });

        // Close when tapping backdrop
        const backdrop = freshMobileMenu.querySelector(".mobile-menu-bg");
        if (backdrop) {
            backdrop.addEventListener(
                "click",
                () => {
                    closeMenu();
                },
                { passive: true },
            );
        }

        // Close with in-panel close button (if present)
        const closeBtn = freshMobileMenu.querySelector(".mobile-menu-close");
        if (closeBtn) {
            closeBtn.addEventListener("click", () => closeMenu());
        }

        // Swipe to close (downward, and only when content is at the top to avoid accidental closes while scrolling)
        const menuContent = freshMobileMenu?.querySelector(".mobile-menu-content");
        let startY = null;
        const threshold = 40;
        freshMobileMenu?.addEventListener(
            "touchstart",
            (e) => {
                startY = e.touches[0].clientY;
            },
            { passive: true },
        );
        freshMobileMenu?.addEventListener(
            "touchmove",
            (e) => {
                if (startY === null) return;
                const deltaY = e.touches[0].clientY - startY;
                const contentAtTop = !menuContent || menuContent.scrollTop <= 0;
                // Swipe down closes the menu (common bottom-sheet behavior)
                if (deltaY > threshold && contentAtTop) {
                    closeMenu();
                    startY = null;
                }
            },
            { passive: true },
        );
        freshMobileMenu?.addEventListener(
            "touchend",
            () => {
                startY = null;
            },
            { passive: true },
        );

        // Close on escape key
        const escapeHandler = (e) => {
            if (e.key === "Escape") {
                closeMenu();
            }
        };
        if (window.__mobileMenuEscapeHandler) {
            document.removeEventListener(
                "keydown",
                window.__mobileMenuEscapeHandler,
            );
        }
        window.__mobileMenuEscapeHandler = escapeHandler;
        document.addEventListener("keydown", escapeHandler);
    }

    initMobileMenu();

    // Re-initialize after View Transitions page swap
    document.addEventListener("astro:page-load", () => {
        initMobileMenu();
    });

    // Dropdown Menu Functionality - Optimized with event delegation
    function initDropdowns() {
        const dropdownContainers = document.querySelectorAll(
            ".dropdown-container",
        );
        if (dropdownContainers.length === 0) return;

        // Single click handler for all dropdowns (event delegation)
        document.addEventListener(
            "click",
            function (e) {
                const button = e.target.closest(".dropdown-button");

                if (button) {
                    const container = button.closest(".dropdown-container");
                    // Close other dropdowns
                    dropdownContainers.forEach((otherContainer) => {
                        if (otherContainer !== container) {
                            otherContainer.classList.remove("active");
                        }
                    });
                    // Toggle current
                    container?.classList.toggle("active");
                    e.stopPropagation();
                } else if (!e.target.closest(".dropdown-menu")) {
                    // Close all if clicking outside
                    dropdownContainers.forEach((container) => {
                        container.classList.remove("active");
                    });
                }
            },
            { passive: true },
        );

        // Close on navigation
        document.querySelectorAll(".dropdown-menu a").forEach((link) => {
            link.addEventListener(
                "click",
                function () {
                    dropdownContainers.forEach((container) => {
                        container.classList.remove("active");
                    });
                },
                { passive: true },
            );
        });
    }

    // Defer dropdown initialization until after page is interactive
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initDropdowns);
    } else {
        // Use requestIdleCallback for better performance
        if ("requestIdleCallback" in window) {
            requestIdleCallback(initDropdowns);
        } else {
            setTimeout(initDropdowns, 1);
        }
    }

    // Toast Notification System
    window.showToast = function (message, type = "success") {
        const container = document.getElementById("toast-container");
        if (!container) return;

        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.setAttribute("role", "alert");
        toast.setAttribute("aria-live", "polite");

        const icons = {
            success: "✓",
            error: "✕",
            info: "ℹ",
        };

        toast.innerHTML = `
            <div class="toast-icon" style="color: ${type === "success" ? "#10b981" : type === "error" ? "#ef4444" : "#3b82f6"}; font-size: 18px; font-weight: bold;">
                ${icons[type] || icons.info}
            </div>
            <div class="toast-message">${message}</div>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add("show");
        }, 100);

        setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

    // ===========================================================
    // Form Result Modal (center popup) - clearer completion message
    // Works across Astro View Transitions via event delegation.
    // ===========================================================
    (function () {
        function isOpen() {
            const modal = document.getElementById("form-modal");
            return modal && !modal.classList.contains("hidden");
        }

        function open(title, message, type) {
            const modal = document.getElementById("form-modal");
            const titleEl = document.getElementById("form-modal-title");
            const messageEl = document.getElementById("form-modal-message");
            const okBtn = document.getElementById("form-modal-ok");

            if (!modal || !titleEl || !messageEl) return;

            // Remember focus per open (stored on body dataset)
            const active = document.activeElement;
            if (active && active.id) {
                document.body.dataset.formModalReturnFocus = active.id;
            } else {
                document.body.dataset.formModalReturnFocus = "";
            }

            modal.setAttribute("data-type", type || "success");
            titleEl.textContent = title || "送信が完了しました";
            messageEl.textContent =
                message || "送信が完了しました。ありがとうございます。";
            modal.classList.remove("hidden");
            modal.setAttribute("aria-hidden", "false");
            document.body.classList.add("form-modal-open");

            setTimeout(() => {
                okBtn?.focus?.({ preventScroll: true });
            }, 0);
        }

        function close() {
            const modal = document.getElementById("form-modal");
            if (!modal) return;
            modal.classList.add("hidden");
            modal.setAttribute("aria-hidden", "true");
            document.body.classList.remove("form-modal-open");

            const returnId = document.body.dataset.formModalReturnFocus;
            if (returnId) {
                const el = document.getElementById(returnId);
                el?.focus?.({ preventScroll: true });
            }
            document.body.dataset.formModalReturnFocus = "";
        }

        // Expose for page-level form scripts
        window.showFormModal = function (title, message, type = "success") {
            open(title, message, type);
        };
        window.hideFormModal = close;

        // Bind delegated handlers only once per session
        if (window.__formModalDelegated) return;
        window.__formModalDelegated = true;

        document.addEventListener("click", (e) => {
            const target = e.target;
            const closeEl = target?.closest?.("[data-form-modal-close]");
            if (closeEl) {
                e.preventDefault();
                close();
            }
        });

        document.addEventListener("keydown", (e) => {
            if (!isOpen()) return;
            if (e.key === "Escape") {
                e.preventDefault();
                close();
            }
        });
    })();

    // View Transitions API with NProgress Integration
    document.addEventListener("astro:before-preparation", () => {
        if (typeof NProgress !== "undefined") {
            NProgress.start();
        }
    });

    document.addEventListener("astro:after-swap", () => {
        if (typeof NProgress !== "undefined") {
            NProgress.done();
        }
    });

    document.addEventListener("astro:page-load", () => {
        if (typeof NProgress !== "undefined") {
            NProgress.done();
        }
    });

    // Page loading indicator (avoid flicker with small delay)
    (function () {
        const indicator = document.getElementById("page-loading-indicator");
        if (!indicator) return;
        let showTimer = null;
        let hideTimer = null;

        const show = () => {
            if (hideTimer) {
                clearTimeout(hideTimer);
                hideTimer = null;
            }
            showTimer = setTimeout(() => {
                indicator.classList.remove("opacity-0", "translate-y-2");
                indicator.classList.add("opacity-100", "translate-y-0");
            }, 120); // small delay to prevent flash on very fast navigations
        };

        const hide = () => {
            if (showTimer) {
                clearTimeout(showTimer);
                showTimer = null;
            }
            hideTimer = setTimeout(() => {
                indicator.classList.add("opacity-0", "translate-y-2");
                indicator.classList.remove("opacity-100", "translate-y-0");
            }, 80);
        };

        document.addEventListener("astro:before-preparation", show);
        document.addEventListener("astro:after-swap", hide);
        document.addEventListener("astro:page-load", hide);
    })();

    // Back to Top Button Handler + scroll-reactive background
    window.addEventListener(
        "scroll",
        function () {
            const backToTopBtn = document.getElementById("back-to-top");
            const rootEl = document.documentElement;
            if (backToTopBtn && rootEl) {
                if (window.scrollY > 300) {
                    backToTopBtn.classList.remove("opacity-0", "invisible");
                    backToTopBtn.classList.add("opacity-100", "visible");
                } else {
                    backToTopBtn.classList.add("opacity-0", "invisible");
                    backToTopBtn.classList.remove("opacity-100", "visible");
                }

                const doc = document.documentElement;
                const max =
                    doc.scrollHeight - doc.clientHeight || 1;
                const progress = Math.min(
                    100,
                    Math.max(0, (window.scrollY / max) * 100),
                );
                backToTopBtn.style.setProperty(
                    "--scroll-progress",
                    progress.toString(),
                );
                // update scroll background strength (0–1)
                const strength = Math.min(
                    1,
                    Math.max(0, progress / 100),
                );
                rootEl.style.setProperty(
                    "--scroll-bg-strength",
                    strength.toFixed(2),
                );
            }
        },
        { passive: true },
    );

    // ===========================================
    // SCROLL ANIMATIONS - Intersection Observer
    // ===========================================
    function initScrollAnimations() {
        const animatedElements = document.querySelectorAll("[data-animate]");

        if (animatedElements.length === 0) return;

        // Check for reduced motion preference
        const prefersReducedMotion = window.matchMedia(
            "(prefers-reduced-motion: reduce)",
        ).matches;

        if (prefersReducedMotion) {
            // Immediately show all elements without animation
            animatedElements.forEach((el) =>
                el.classList.add("animate-visible"),
            );
            return;
        }

        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add("animate-visible");
                        // Unobserve after animation to improve performance
                        observer.unobserve(entry.target);
                    }
                });
            },
            {
                threshold: 0.1,
                rootMargin: "0px 0px -50px 0px",
            },
        );

        animatedElements.forEach((el) => observer.observe(el));
    }

    // Initialize on page load and after View Transitions
    initScrollAnimations();
    document.addEventListener("astro:page-load", initScrollAnimations);

    // ===========================================
    // ENHANCED RIPPLE EFFECT
    // ===========================================
    function initRippleEffect() {
        const rippleButtons = document.querySelectorAll('.btn-ripple-enhanced');
        
        rippleButtons.forEach(btn => {
            // Remove existing listeners by cloning
            const newBtn = btn.cloneNode(true);
            btn.parentNode?.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', function(e) {
                const rect = this.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const ripple = document.createElement('span');
                ripple.className = 'ripple';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                
                // Size based on button dimensions
                const size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.marginLeft = ripple.style.marginTop = -(size / 2) + 'px';
                
                this.appendChild(ripple);
                
                // Remove ripple after animation
                setTimeout(() => ripple.remove(), 600);
            });
        });
    }
    
    initRippleEffect();
    document.addEventListener('astro:page-load', initRippleEffect);

    // ===========================================
    // CONFETTI CELEBRATION
    // ===========================================
    window.showConfetti = function(options = {}) {
        const {
            count = 50,
            duration = 3000,
            colors = ['#006837', '#00a855', '#fbbf24', '#f59e0b', '#ef4444', '#3b82f6']
        } = options;
        
        const container = document.createElement('div');
        container.className = 'confetti-container';
        document.body.appendChild(container);
        
        const shapes = ['confetti-square', 'confetti-circle', 'confetti-triangle'];
        
        for (let i = 0; i < count; i++) {
            const confetti = document.createElement('div');
            confetti.className = `confetti ${shapes[Math.floor(Math.random() * shapes.length)]}`;
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 0.5 + 's';
            confetti.style.animationDuration = (Math.random() * 1 + 2) + 's';
            
            // Random rotation
            const rotation = Math.random() * 360;
            confetti.style.transform = `rotate(${rotation}deg)`;
            
            container.appendChild(confetti);
        }
        
        // Remove container after animation
        setTimeout(() => container.remove(), duration);
    };

    // ===========================================
    // FLOATING LABEL INITIALIZATION
    // ===========================================
    function initFloatingLabels() {
        const floatingGroups = document.querySelectorAll('.floating-label-group');
        
        floatingGroups.forEach(group => {
            const input = group.querySelector('input, textarea');
            const label = group.querySelector('label');
            
            if (!input || !label) return;
            
            // Ensure placeholder is set for CSS to work
            if (!input.placeholder) {
                input.placeholder = ' ';
            }
            
            // Handle autofill
            input.addEventListener('animationstart', (e) => {
                if (e.animationName === 'onAutoFillStart') {
                    input.classList.add('autofilled');
                }
            });
        });
    }
    
    initFloatingLabels();
    document.addEventListener('astro:page-load', initFloatingLabels);

    // ===========================================
    // SCROLL REVEAL - Organic Animation (Enhanced)
    // ===========================================
    function initScrollReveal() {
        // すべてのscroll-reveal系のクラスを持つ要素を取得
        const revealElements = document.querySelectorAll(
            '.scroll-reveal, .scroll-reveal-fade, .scroll-reveal-slide-up, .scroll-reveal-slide-left, .scroll-reveal-slide-right, .scroll-reveal-scale, .scroll-reveal-rotate'
        );
        
        if (revealElements.length === 0) return;
        
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        
        if (prefersReducedMotion) {
            revealElements.forEach(el => el.classList.add('revealed'));
            return;
        }
        
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('revealed');
                        observer.unobserve(entry.target);
                    }
                });
            },
            {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px' // 要素が50px見えたら発動
            }
        );
        
        revealElements.forEach(el => observer.observe(el));
    }
    
    initScrollReveal();
    document.addEventListener('astro:page-load', initScrollReveal);

    // ===========================================
    // PARALLAX - Slow Background Movement
    // ===========================================
    function initParallax() {
        const parallaxElements = document.querySelectorAll('.parallax-slow');
        
        if (parallaxElements.length === 0) return;
        
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        
        if (prefersReducedMotion) return;
        
        let ticking = false;
        
        function updateParallax() {
            const scrollY = window.scrollY;
            
            parallaxElements.forEach(el => {
                const speed = parseFloat(el.dataset.parallaxSpeed || '0.3');
                const yPos = -(scrollY * speed);
                el.style.transform = `translate3d(0, ${yPos}px, 0)`;
            });
            
            ticking = false;
        }
        
        function requestTick() {
            if (!ticking) {
                window.requestAnimationFrame(updateParallax);
                ticking = true;
            }
        }
        
        window.addEventListener('scroll', requestTick, { passive: true });
    }
    
    initParallax();
    document.addEventListener('astro:page-load', initParallax);
</script>
