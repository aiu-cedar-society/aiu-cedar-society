---
/**
 * Language Switcher Component - Dropdown Version
 *
 * Displays a dropdown to switch between Japanese and English versions.
 * Uses localStorage to persist language preference.
 */

import { getLangFromUrl, getLocalizedPath } from "../i18n/utils";

const currentLang = getLangFromUrl(Astro.url);
const pathname = Astro.url.pathname;

// Calculate the base path without language prefix
let basePath = pathname;
if (currentLang === "en") {
    basePath = pathname.replace(/^\/en/, "") || "/";
}

// Generate URLs for both languages
const jaUrl = basePath;
const enUrl = "/en" + (basePath === "/" ? "" : basePath);
---

<div class="lang-switcher-container" id="lang-switcher">
    <span class="sr-only">言語を選択</span>
    <button
        class="lang-switcher-button"
        aria-label="Select language"
        aria-expanded="false"
        aria-haspopup="true"
        aria-controls="lang-dropdown"
    >
        <span class="lang-icon">
            <svg
                class="w-4 h-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"
                ></path>
            </svg>
        </span>
        <!-- Short code for mobile -->
        <span class="lang-short">{currentLang === "ja" ? "JA" : "EN"}</span>
        <!-- Full text for desktop -->
        <span class="lang-current"
            >{currentLang === "ja" ? "日本語" : "English"}</span
        >
        <span class="lang-arrow">
            <svg
                class="w-3 h-3"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M19 9l-7 7-7-7"></path>
            </svg>
        </span>
    </button>

    <div class="lang-dropdown" role="menu" id="lang-dropdown">
        <a
            href={jaUrl}
            class={`lang-option ${currentLang === "ja" ? "active" : ""}`}
            role="menuitem"
            data-lang="ja"
            tabindex="-1"
        >
            <span class="lang-option-code">JA</span>
            <span>日本語</span>
            {currentLang === "ja" && <span class="lang-check">✓</span>}
        </a>
        <a
            href={enUrl}
            class={`lang-option ${currentLang === "en" ? "active" : ""}`}
            role="menuitem"
            data-lang="en"
            tabindex="-1"
        >
            <span class="lang-option-code">EN</span>
            <span>English</span>
            {currentLang === "en" && <span class="lang-check">✓</span>}
        </a>
    </div>
</div>

<style>
    .lang-switcher-container {
        position: relative;
        display: inline-block;
    }
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    .lang-switcher-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.375rem;
        padding: 0.375rem 0.625rem;
        font-size: 0.8125rem;
        font-weight: 600;
        color: #374151;
        background: #f3f4f6;
        border: 1px solid transparent;
        border-radius: 9999px;
        cursor: pointer;
        transition: all 0.2s ease;
        line-height: 1.2;
        vertical-align: middle;
        height: 32px;
    }

    .lang-switcher-button:hover {
        background: #e5e7eb;
        border-color: #d1d5db;
    }

    .lang-switcher-button:focus-visible {
        border-radius: 9999px;
    }

    .lang-switcher-container.open .lang-switcher-button {
        background: #006837;
        color: white;
    }

    .lang-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    /* Short code (JA/EN) - shown on mobile */
    .lang-short {
        display: none;
        font-weight: 700;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        line-height: 1;
    }

    /* Full text (日本語/English) - shown on desktop */
    .lang-current {
        font-weight: 600;
        letter-spacing: 0.025em;
        line-height: 1;
    }

    .lang-arrow {
        display: flex;
        align-items: center;
        transition: transform 0.2s ease;
    }

    .lang-switcher-container.open .lang-arrow {
        transform: rotate(180deg);
    }

    .lang-dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        right: 0;
        min-width: 160px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        box-shadow:
            0 10px 25px -5px rgba(0, 0, 0, 0.1),
            0 8px 10px -6px rgba(0, 0, 0, 0.1);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 9999;
        overflow: hidden;
    }

    .lang-switcher-container.open .lang-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .lang-option {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        text-decoration: none;
        transition: background 0.15s ease;
    }

    .lang-option:hover {
        background: #f3f4f6;
    }

    .lang-option.active {
        background: #f0fdf4;
        color: #006837;
    }

    .lang-option-code {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.75rem;
        height: 1.25rem;
        font-size: 0.625rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        color: #6b7280;
        background: #f3f4f6;
        border-radius: 0.25rem;
    }

    .lang-option.active .lang-option-code {
        background: #dcfce7;
        color: #006837;
    }

    .lang-check {
        margin-left: auto;
        color: #006837;
        font-weight: 600;
    }

    /* Mobile styles */
    @media (max-width: 768px) {
        .lang-switcher-button {
            padding: 0.375rem 0.5rem;
            gap: 0.25rem;
            height: 36px;
        }

        .lang-short {
            display: inline;
        }

        .lang-current {
            display: none;
        }

        .lang-arrow {
            display: none;
        }

        .lang-dropdown {
            right: -0.5rem;
            min-width: 150px;
        }
    }
</style>

<script is:inline>
    // Language Switcher Dropdown Logic
    (function () {
        // Store references for cleanup
        let currentContainer = null;
        let outsideClickHandler = null;
        let escapeHandler = null;
        let keydownHandler = null;

        function initLangSwitcher() {
            // Clean up previous listeners if any
            if (outsideClickHandler) {
                document.removeEventListener("click", outsideClickHandler);
            }
            if (escapeHandler) {
                document.removeEventListener("keydown", escapeHandler);
            }
            if (keydownHandler) {
                document.removeEventListener("keydown", keydownHandler);
            }

            const container = document.getElementById("lang-switcher");
            if (!container) return;

            currentContainer = container;
            const button = container.querySelector(".lang-switcher-button");
            const options = container.querySelectorAll(".lang-option");
            const dropdown = container.querySelector(".lang-dropdown");

            // Toggle dropdown - use onclick to avoid duplicate listeners
            if (button) {
                button.onclick = function (e) {
                    e.stopPropagation();
                    const isOpen = container.classList.contains("open");
                    container.classList.toggle("open");
                    button.setAttribute("aria-expanded", String(!isOpen));
                    if (!isOpen) {
                        // focus first option when opening
                        const first = options[0];
                        first?.focus({ preventScroll: true });
                    }
                };
            }

            // Close on outside click
            outsideClickHandler = function (e) {
                if (container && !container.contains(e.target)) {
                    container.classList.remove("open");
                    if (button) button.setAttribute("aria-expanded", "false");
                }
            };
            document.addEventListener("click", outsideClickHandler);

            // Close on escape
            escapeHandler = function (e) {
                if (e.key === "Escape" && container) {
                    container.classList.remove("open");
                    if (button) button.setAttribute("aria-expanded", "false");
                    button?.focus({ preventScroll: true });
                }
            };
            document.addEventListener("keydown", escapeHandler);

            // Keyboard navigation inside dropdown
            keydownHandler = function (e) {
                if (!container.classList.contains("open")) return;
                const focusable = Array.from(options);
                const idx = focusable.indexOf(document.activeElement);
                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    const next = focusable[(idx + 1) % focusable.length];
                    next?.focus({ preventScroll: true });
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    const prev =
                        focusable[
                            (idx - 1 + focusable.length) % focusable.length
                        ];
                    prev?.focus({ preventScroll: true });
                } else if (e.key === "Enter" || e.key === " ") {
                    if (
                        document.activeElement?.classList.contains(
                            "lang-option",
                        )
                    ) {
                        const href =
                            document.activeElement.getAttribute("href");
                        if (href) {
                            window.location.href = href;
                        }
                    }
                }
            };
            document.addEventListener("keydown", keydownHandler);

            // Save language preference when clicking an option - use onclick
            options.forEach(function (option) {
                option.onclick = function () {
                    var lang = option.getAttribute("data-lang");
                    if (lang) {
                        localStorage.setItem("preferredLanguage", lang);
                        container.classList.remove("open");
                        button?.setAttribute("aria-expanded", "false");
                    }
                };
            });

            // Annotate preferred language (for potential UI use)
            const preferred = localStorage.getItem("preferredLanguage");
            if (preferred && dropdown) {
                dropdown.setAttribute(
                    "data-preferred",
                    preferred === "en" ? "English" : "日本語",
                );
            }
        }

        // Initialize immediately
        initLangSwitcher();

        // Reinitialize after View Transitions page swap
        document.addEventListener("astro:after-swap", function () {
            initLangSwitcher();
        });

        // Also reinitialize on astro:page-load for good measure
        document.addEventListener("astro:page-load", function () {
            initLangSwitcher();
        });
    })();
</script>
