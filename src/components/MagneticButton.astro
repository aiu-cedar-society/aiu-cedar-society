---
interface Props {
  href?: string;
  className?: string;
  strength?: number;
  ariaLabel?: string;
}

const {
  href = "",
  className = "",
  strength = 0.25,
  ariaLabel = "",
} = Astro.props;

const isLink = Boolean(href);
---

{isLink ? (
  <a
    href={href}
    class={`magnetic-button ${className}`}
    data-strength={strength}
    aria-label={ariaLabel || undefined}
  >
    <slot />
  </a>
) : (
  <button
    type="button"
    class={`magnetic-button ${className}`}
    data-strength={strength}
    aria-label={ariaLabel || undefined}
  >
    <slot />
  </button>
)}

<script>
  const initMagnetic = (el: HTMLElement) => {
    const strength = parseFloat(el.dataset.strength || "0.25");
    let bounds: DOMRect;

    const updateBounds = () => {
      bounds = el.getBoundingClientRect();
    };

    const onMove = (e: MouseEvent) => {
      const x = e.clientX - bounds.left - bounds.width / 2;
      const y = e.clientY - bounds.top - bounds.height / 2;
      el.style.transform = `translate(${x * strength}px, ${y * strength}px)`;
    };

    const onLeave = () => {
      el.style.transform = "translate(0, 0)";
    };

    updateBounds();
    el.addEventListener("mousemove", onMove);
    el.addEventListener("mouseleave", onLeave);
    window.addEventListener("resize", updateBounds);

    return () => {
      el.removeEventListener("mousemove", onMove);
      el.removeEventListener("mouseleave", onLeave);
      window.removeEventListener("resize", updateBounds);
    };
  };

  if (typeof window !== "undefined") {
    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)",
    ).matches;

    if (!prefersReducedMotion) {
      const cleanupFns: Array<() => void> = [];
      document.querySelectorAll(".magnetic-button").forEach((el) => {
        const cleanup = initMagnetic(el as HTMLElement);
        cleanupFns.push(cleanup);
      });

      document.addEventListener("astro:page-load", () => {
        document.querySelectorAll(".magnetic-button").forEach((el) => {
          const cleanup = initMagnetic(el as HTMLElement);
          cleanupFns.push(cleanup);
        });
      });

      document.addEventListener("astro:before-swap", () => {
        cleanupFns.forEach((fn) => fn());
      });
    }
  }
</script>

<style>
  .magnetic-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    will-change: transform;
  }

  @media (prefers-reduced-motion: reduce) {
    .magnetic-button {
      transition: none;
      transform: none !important;
    }
  }
</style>



