---
import Layout from "../../layouts/Layout.astro";
import Marquee from "../../components/Marquee.astro";
import MagneticButton from "../../components/MagneticButton.astro";
import { getCollection } from "astro:content";
import { getPages } from "../../library/microcms";
import { useTranslations, formatDate, formatDateTime, getContent } from "../../i18n/utils";

const lang = "en";
const t = useTranslations(lang);

// Fetch lectures using Content Layer API
const allLectures = await getCollection("lectures");

// Sort by event_date (newest first) and take top 4
const lectures = allLectures
    .map((lecture) => ({
        id: lecture.id,
        title: lecture.data.title,
        title_en: lecture.data.title_en,
        guest_name: lecture.data.guest_name,
        guest_name_en: lecture.data.guest_name_en,
        belonging: lecture.data.belonging,
        belonging_en: lecture.data.belonging_en,
        event_date: lecture.data.event_date,
        eyecatch: lecture.data.eyecatch,
    }))
    .sort(
        (a, b) =>
            new Date(b.event_date).getTime() - new Date(a.event_date).getTime(),
    )
    .slice(0, 4);

// Fetch upcoming events using Content Layer API
const allUpcomingEvents = await getCollection("upcoming_events");
const upcomingEvents = allUpcomingEvents.map((event) => ({
    id: event.id,
    title: event.data.title,
    title_en: event.data.title_en,
    event_date: event.data.event_date,
    description: event.data.description,
    description_en: event.data.description_en,
    location: event.data.location,
    location_en: event.data.location_en,
}));

// Fetch sponsors for marquee (pages is singleton, keep using legacy method)
let sponsors: Array<{ name: string; logo?: string; url?: string }> = [];
try {
    const pages = await getPages();
    sponsors = (pages.sponsors || []).map((s: any) => ({
        name: s.name,
        logo: s.logo?.url,
        url: s.url,
    }));
} catch (error) {
    console.error("Error fetching sponsors:", error);
}

// SEO
const seo = {
    title: "AIU Cedar Society - Connecting Akita with AIU Students",
    description:
        "AIU Cedar Society is a student-led official organization at Akita International University. Through lectures with distinguished guests, we connect students with Akita society, creating a cycle of encounter, learning, and practice.",
    keywords:
        "AIU Cedar Society,Akita International University,AIU,Student Organization,Lectures,Akita,Events,Career Support,Entrepreneurs,Regional Revitalization",
    ogType: "website" as const,
};

---

<Layout seo={seo}>
    <div class="min-h-screen relative overflow-hidden">
        {/* Hero Section with 3D Depth */}
        <section
            class="relative pt-24 md:pt-28 pb-12 md:pb-16 px-4 md:px-6 hero-3d-container"
        >
            <div class="container mx-auto px-4 md:px-6 max-w-5xl">
                <div class="relative hero-content hero-3d-content">
                    <div class="relative mb-4 md:mb-6">
                        <div
                            class="absolute top-0 left-0 w-px h-full bg-[#006837] hero-line"
                        >
                        </div>
                        <h1 class="typography-hero pl-6">
                            <span class="inline-block hero-text-1"
                                >Connecting Akita & AIU</span
                            ><br />
                            <span
                                class="text-[#006837] inline-block hero-text-2 typography-hero-accent"
                                >Possibilities</span
                            >
                        </h1>
                    </div>
                    <p
                        class="text-base md:text-lg text-gray-600 leading-relaxed pl-6 hero-description"
                    >
                        AIU Cedar Society bridges student enthusiasm with Akita
                        society.<br />
                        We create a cycle of "encounter, learn, and practice," generating
                        new value in Akita.
                    </p>
                </div>
            </div>
        </section>

        {/* Upcoming Events Section */}
        {
            upcomingEvents.length > 0 && (
                <!-- Let the global washi background show through; keep cards as surfaces -->
                <section class="py-12 md:py-16 bg-transparent">
                    <div class="container mx-auto px-4 md:px-6 max-w-6xl">
                        {/* Section Header */}
                        <div
                            class="flex items-center justify-between mb-8 md:mb-12"
                            data-animate
                        >
                            <div class="flex items-center gap-4">
                                <div class="w-8 h-8 bg-[#006837] bg-opacity-10 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg
                                        class="w-5 h-5 text-[#006837]"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                                        />
                                    </svg>
                                </div>
                                <h2 class="typography-section">
                                    Upcoming
                                    <span class="text-[#006837]">Events</span>
                                </h2>
                            </div>
                            <a
                                href="/en/events/upcoming"
                                class="hidden sm:flex items-center gap-2 text-sm text-[#006837] hover:gap-3 transition-all duration-300 typography-nav"
                            >
                                <span>View Details</span>
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 5l7 7-7 7"
                                    />
                                </svg>
                            </a>
                        </div>

                        {/* Events List */}
                        <div class="space-y-6">
                            {upcomingEvents.slice(0, 2).map((event, index) => (
                                <div
                                    class={`border-l-4 border-[#006837] bg-gray-50/80 p-6 rounded-r-lg hover-lift glass-card scroll-reveal scroll-reveal-delay-${index + 1} organic-hover`}
                                    data-animate
                                    data-animate-delay={index + 1}
                                >
                                    <div class="flex items-start gap-4 mb-3">
                                        <div class="inline-flex items-center gap-2 bg-white border border-gray-200 px-3 py-1.5 rounded-full shadow-sm">
                                            <svg
                                                class="w-3.5 h-3.5 text-[#006837]"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                                                />
                                            </svg>
                                            <div class="typography-label text-[#006837]">
                                                {formatDateTime(
                                                    event.event_date,
                                                    lang,
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-900 mb-2">
                                        {getContent(
                                            event.title_en,
                                            event.title,
                                        )}
                                    </h3>
                                    {event.location && (
                                        <p class="text-sm text-gray-600 mb-3 flex items-center gap-2">
                                            <svg
                                                class="w-4 h-4"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                                />
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                                />
                                            </svg>
                                            {getContent(
                                                event.location_en,
                                                event.location,
                                            )}
                                        </p>
                                    )}
                                    <div
                                        class="prose prose-sm max-w-none text-gray-700"
                                        set:html={getContent(
                                            event.description_en,
                                            event.description,
                                        )}
                                    />
                                </div>
                            ))}
                        </div>

                        {/* Mobile View All Button */}
                        <div class="mt-8 sm:hidden text-center">
                            <MagneticButton
                                href="/en/events/upcoming"
                                class="inline-flex items-center gap-2 px-6 py-3 bg-[#006837] text-white rounded-lg hover:bg-[#005028] transition-colors duration-300 btn-ripple-enhanced btn-organic typography-button"
                                strength={0.25}
                                ariaLabel="View All Events"
                            >
                                <span>View All Events</span>
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 5l7 7-7 7"
                                    />
                                </svg>
                            </MagneticButton>
                        </div>
                    </div>
                </section>
            )
        }

        {/* Lecture List */}
        <main
            class="container mx-auto px-4 md:px-6 py-12 md:py-16 max-w-6xl relative"
        >
            <div
                class="flex items-center justify-between mb-10 md:mb-14 section-header"
                data-animate
            >
                <div class="flex items-center gap-4">
                    <div
                        class="w-6 h-6 bg-[#006837] bg-opacity-10 rounded-lg flex items-center justify-center flex-shrink-0"
                    >
                        <svg
                            class="w-4 h-4 text-[#006837]"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                            ></path>
                        </svg>
                    </div>
                    <h2 class="typography-section">
                        Recent Lectures
                    </h2>
                </div>
                <a
                    href="/en/events/past"
                    class="hidden sm:flex items-center gap-2 text-sm font-medium text-[#006837] hover:gap-3 transition-all duration-300"
                >
                    <span>View All</span>
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5l7 7-7 7"></path>
                    </svg>
                </a>
            </div>

            {/* Lecture Cards Grid */}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                {
                    lectures.map((lecture, index) => (
                        <a
                            href={`/en/lectures/${lecture.id}`}
                            class="lecture-card block group card-tilt"
                        >
                            <div
                                class={`bg-white/90 rounded-lg shadow-md hover:shadow-xl transition-all duration-500 overflow-hidden ring-1 ring-gray-100 group-hover:ring-[#006837]/30 hover-lift glass-card scroll-reveal scroll-reveal-delay-${index + 1}`}
                                data-animate
                                data-animate-delay={index + 1}
                            >
                                <div class="flex flex-row gap-0">
                                    {/* Image */}
                                    <div class="w-24 sm:w-32 md:w-48 flex-shrink-0 relative overflow-hidden bg-gray-100">
                                        <div class="aspect-[3/4] md:aspect-[210/297]">
                                            {lecture.eyecatch ? (
                                                <img
                                                    src={`${lecture.eyecatch.url}?w=192&fm=webp&q=60`}
                                                    srcset={`
                                                        ${lecture.eyecatch.url}?w=96&fm=webp&q=60 96w,
                                                        ${lecture.eyecatch.url}?w=128&fm=webp&q=60 128w,
                                                        ${lecture.eyecatch.url}?w=192&fm=webp&q=60 192w,
                                                        ${lecture.eyecatch.url}?w=256&fm=webp&q=60 256w,
                                                        ${lecture.eyecatch.url}?w=384&fm=webp&q=60 384w
                                                    `}
                                                    sizes="(max-width: 640px) 96px, (max-width: 768px) 128px, 192px"
                                                    alt={getContent(
                                                        lecture.title_en,
                                                        lecture.title,
                                                    )}
                                                    width="192"
                                                    height="256"
                                                    loading={
                                                        index < 2
                                                            ? "eager"
                                                            : "lazy"
                                                    }
                                                    fetchpriority={
                                                        index === 0
                                                            ? "high"
                                                            : "auto"
                                                    }
                                                    decoding="async"
                                                    class="w-full h-full object-cover img-organic-hover"
                                                />
                                            ) : (
                                                <div class="w-full h-full bg-gradient-to-br from-[#006837] to-[#005028] flex items-center justify-center">
                                                    <svg
                                                        class="w-10 h-10 md:w-16 md:h-16 text-white opacity-40"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="1.5"
                                                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                                                        />
                                                    </svg>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Content */}
                                    <div class="flex-1 p-4 sm:p-5 md:p-6 flex flex-col justify-between min-w-0">
                                        <div>
                                            <div class="flex items-center gap-2 text-xs text-gray-500 mb-2 md:mb-3">
                                                <svg
                                                    class="w-3.5 h-3.5 flex-shrink-0"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                                                    />
                                                </svg>
                                                <span class="truncate">
                                                    {formatDate(
                                                        lecture.event_date,
                                                        lang,
                                                    )}
                                                </span>
                                            </div>

                                            <h3 class="text-base sm:text-lg md:text-xl font-bold text-gray-900 mb-1.5 md:mb-2 leading-tight group-hover:text-[#006837] transition-colors line-clamp-2">
                                                {getContent(
                                                    lecture.title_en,
                                                    lecture.title,
                                                )}
                                            </h3>

                                            <p class="text-sm sm:text-base text-[#006837] font-semibold truncate">
                                                {getContent(
                                                    lecture.guest_name_en,
                                                    lecture.guest_name,
                                                )}
                                            </p>
                                            {lecture.belonging && (
                                                <p class="text-xs sm:text-sm text-gray-600 mb-2 md:mb-3 truncate">
                                                    {getContent(
                                                        lecture.belonging_en,
                                                        lecture.belonging,
                                                    )}
                                                </p>
                                            )}
                                        </div>

                                        <div class="flex items-center text-xs sm:text-sm text-[#006837] font-medium">
                                            <span class="mr-1">
                                                View Details
                                            </span>
                                            <svg
                                                class="w-3.5 h-3.5 sm:w-4 sm:h-4 transform group-hover:translate-x-1 transition-transform"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M9 5l7 7-7 7"
                                                />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    ))
                }
            </div>

            {/* View All Button */}
            <div class="mt-10 md:mt-12 text-center">
                <MagneticButton
                    href="/en/events/past"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-white border-2 border-[#006837] text-[#006837] rounded-lg hover:bg-[#006837] hover:text-white transition-all duration-300 shadow-md hover:shadow-lg min-h-[44px] typography-button"
                    strength={0.25}
                    ariaLabel="See All Lectures"
                >
                    <span>See All Lectures</span>
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5l7 7-7 7"></path>
                    </svg>
                </MagneticButton>
            </div>
        </main>

        {/* Sponsors Marquee Section */}
        {sponsors.length > 0 && (
            <!-- Keep section background transparent for seamless page background -->
            <section class="py-12 md:py-16 bg-transparent">
                <div class="container mx-auto px-4 md:px-6 max-w-6xl">
                    <div class="mb-8 scroll-reveal-slide-up">
                        <h2 class="typography-section text-center mb-4">
                            Sponsors
                        </h2>
                        <p class="text-center text-gray-600 max-w-2xl mx-auto">
                            Partners who support AIU Cedar Society
                        </p>
                    </div>
                    <Marquee
                        items={sponsors}
                        speed="normal"
                        direction="left"
                    />
                    <div class="mt-8 text-center">
                        <a
                            href="/en/sponsors"
                            class="inline-flex items-center gap-2 text-sm text-[#006837] hover:gap-3 transition-all duration-300 typography-nav"
                        >
                            <span>View all sponsors</span>
                            <svg
                                class="w-4 h-4"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 5l7 7-7 7"
                                />
                            </svg>
                        </a>
                    </div>
                </div>
            </section>
        )}
    </div>
</Layout>

<style>
    /* Gradient Background Animation */
    @keyframes gradient-shift {
        0%,
        100% {
            opacity: 1;
            transform: translate(0, 0) scale(1);
        }
        50% {
            opacity: 0.8;
            transform: translate(10px, 10px) scale(1.05);
        }
    }

    .animate-gradient-shift {
        animation: gradient-shift 20s ease-in-out infinite;
    }

    /* Hero Section Animations */
    /* SPEED INDEX FIX: Show content immediately, only animate after JS adds hero-animate class */
    .hero-content {
        opacity: 1;
    }
    
    .hero-content.hero-animate {
        animation: fade-in-up 0.8s ease-out;
    }

    .hero-line {
        opacity: 1;
    }
    
    .hero-line.hero-animate {
        animation: slide-down 0.6s ease-out;
    }

    .hero-text-1 {
        opacity: 1;
    }
    
    .hero-text-1.hero-animate {
        animation: fade-in-right 0.8s ease-out 0.3s both;
    }

    .hero-text-2 {
        opacity: 1;
    }
    
    .hero-text-2.hero-animate {
        animation: fade-in-right 0.8s ease-out 0.5s both;
    }

    .hero-description {
        opacity: 1;
    }
    
    .hero-description.hero-animate {
        animation: fade-in 1s ease-out 0.7s both;
    }

    /* Section Header Animation */
    /* SPEED INDEX FIX: Show immediately, animate only after page is interactive */
    .section-header {
        opacity: 1;
    }
    
    .section-header.hero-animate {
        animation: fade-in-up 0.8s ease-out 0.9s both;
    }

    /* Keyframes */
    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* 3D Hero Effects */
    .hero-3d-container {
        perspective: 1200px;
        perspective-origin: center center;
    }

    .hero-3d-content {
        transform-style: preserve-3d;
    }

    .hero-3d-content h1 {
        transform: translateZ(20px);
        transform-style: preserve-3d;
    }

    .hero-3d-content p {
        transform: translateZ(10px);
    }

    .hero-3d-content .hero-line {
        transform: translateZ(15px);
    }

    /* Disable 3D for users who prefer reduced motion */
    @media (prefers-reduced-motion: reduce) {
        .hero-3d-container {
            perspective: none;
        }

        .hero-3d-content,
        .hero-3d-content h1,
        .hero-3d-content p,
        .hero-3d-content .hero-line {
            transform: none !important;
        }
    }

    @keyframes fade-in-right {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes fade-in {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes slide-down {
        from {
            height: 0;
        }
        to {
            height: 100%;
        }
    }

    /* Smooth scroll behavior */
    @media (prefers-reduced-motion: no-preference) {
        html {
            scroll-behavior: smooth;
        }
    }

    /* Disable animations for users who prefer reduced motion */
    @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
</style>

<script is:inline>
    // Parallax Effect for Hero Background with 3D Depth (Passive & Performance Optimized)
    (function () {
        const parallaxBg = document.getElementById("parallax-bg");
        if (!parallaxBg) return;

        let ticking = false;

        function updateParallax() {
            const scrolled = window.pageYOffset;
            const rate = scrolled * 0.3; // Parallax speed (30% of scroll speed)

            // Use transform for GPU acceleration with 3D depth
            parallaxBg.style.transform = `translateY(${rate}px) translateZ(-30px) scale(1.03)`;
            ticking = false;
        }

        function requestTick() {
            if (!ticking) {
                window.requestAnimationFrame(updateParallax);
                ticking = true;
            }
        }

        // Use passive listener for better scroll performance
        window.addEventListener("scroll", requestTick, { passive: true });

        // Check for reduced motion preference
        const prefersReducedMotion = window.matchMedia(
            "(prefers-reduced-motion: reduce)",
        );
        if (prefersReducedMotion.matches) {
            parallaxBg.style.transform = "none";
            window.removeEventListener("scroll", requestTick);
        }

        // Cleanup on page navigation
        document.addEventListener("astro:before-preparation", () => {
            window.removeEventListener("scroll", requestTick);
        });
    })();
</script>

<script is:inline>
    // SPEED INDEX FIX: Enable hero animations after page is interactive
    (function() {
        function enableHeroAnimations() {
            const heroContent = document.querySelector('.hero-content');
            const heroLine = document.querySelector('.hero-line');
            const heroText1 = document.querySelector('.hero-text-1');
            const heroText2 = document.querySelector('.hero-text-2');
            const heroDesc = document.querySelector('.hero-description');
            
            // Check for reduced motion preference
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (prefersReducedMotion) return;
            
            // Add animation classes
            // Add animation classes to hero elements
            if (heroContent) heroContent.classList.add('hero-animate');
            if (heroLine) heroLine.classList.add('hero-animate');
            if (heroText1) heroText1.classList.add('hero-animate');
            if (heroText2) heroText2.classList.add('hero-animate');
            if (heroDesc) heroDesc.classList.add('hero-animate');
            
            // Add animation classes to section headers
            const sectionHeaders = document.querySelectorAll('.section-header');
            sectionHeaders.forEach(el => el.classList.add('hero-animate'));
        }
        
        // Delay animation until after LCP (approximately 500ms)
        if ('requestIdleCallback' in window) {
            requestIdleCallback(enableHeroAnimations, { timeout: 1000 });
        } else {
            setTimeout(enableHeroAnimations, 500);
        }
        
        // Re-enable on page transitions
        document.addEventListener('astro:page-load', function() {
            if ('requestIdleCallback' in window) {
                requestIdleCallback(enableHeroAnimations, { timeout: 1000 });
            } else {
                setTimeout(enableHeroAnimations, 500);
            }
        });
    })();
</script>
