---
import Layout from "../../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import Breadcrumb from "../../../components/Breadcrumb.astro";
import BreadcrumbSchema from "../../../components/BreadcrumbSchema.astro";
import { formatDate, getContent } from "../../../i18n/utils";

// Fetch all lectures (past events) using Content Layer API
const allLectures = await getCollection("lectures");
const lectures = allLectures.map((lecture) => ({
    id: lecture.id,
    title: lecture.data.title,
    title_en: (lecture.data as any).title_en,
    guest_name: lecture.data.guest_name,
    guest_name_en: (lecture.data as any).guest_name_en,
    belonging: lecture.data.belonging,
    belonging_en: (lecture.data as any).belonging_en,
    event_date: lecture.data.event_date,
    eyecatch: lecture.data.eyecatch,
}));

// Group lectures by year
const lecturesByYear = lectures.reduce(
    (acc, lecture) => {
        const year = new Date(lecture.event_date).getFullYear();
        if (!acc[year]) {
            acc[year] = [];
        }
        acc[year].push(lecture);
        return acc;
    },
    {} as Record<number, typeof lectures>,
);

// Sort years descending
const years = Object.keys(lecturesByYear)
    .map(Number)
    .sort((a, b) => b - a);

// SEO
const seo = {
    title: "Past Lectures | AIU Cedar Society",
    description:
        "Archive of lectures hosted by AIU Cedar Society. View records of past lectures featuring distinguished guests.",
    keywords: "AIU Cedar Society,Past Lectures,Archive,History",
};

const breadcrumbItems = [
    { label: "Home", href: "/en" },
    { label: "Past Lectures" },
];
---

<Layout seo={seo}>
    <BreadcrumbSchema items={breadcrumbItems} />
    <div class="min-h-screen">
        <div
            class="container mx-auto px-4 md:px-6 pt-16 md:pt-20 pb-12 md:pb-20 max-w-5xl"
        >
            <Breadcrumb items={breadcrumbItems} />
            {/* Back Button */}
            <a
                href="/en"
                class="inline-flex items-center text-gray-500 hover:text-[#006837] mb-8 md:mb-12 transition-colors group text-sm font-medium min-h-[44px]"
            >
                <svg
                    class="w-4 h-4 mr-2 transform group-hover:-translate-x-1 transition-transform"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Home
            </a>

            {/* Hero Section */}
            <div class="relative mb-12 md:mb-16">
                <div class="relative mb-6">
                    <div class="absolute top-0 left-0 w-px h-full bg-[#006837]">
                    </div>
                    <h1 class="typography-hero pl-6">
                        Past <span class="text-[#006837] typography-hero-accent">Lectures</span>
                    </h1>
                </div>
                <p
                    class="text-lg md:text-xl text-gray-600 leading-relaxed pl-6 max-w-2xl"
                >
                    Archive of our previous lectures
                </p>
            </div>

            {/* Search and Filter Section */}
            <div
                class="mb-8 md:mb-12 bg-white rounded-lg shadow-md p-4 md:p-6 border border-gray-200"
            >
                <div class="flex flex-col md:flex-row gap-4">
                    {/* Search Input */}
                    <div class="flex-1">
                        <label for="lecture-search" class="sr-only"
                            >Search lectures</label
                        >
                        <div class="relative">
                            <svg
                                class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                                ></path>
                            </svg>
                            <input
                                type="search"
                                id="lecture-search"
                                placeholder="Search by title or speaker name..."
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#006837] focus:border-transparent transition-all"
                            />
                        </div>
                    </div>

                    {/* Year Filters */}
                    <div class="flex gap-2 flex-wrap" id="year-filters">
                        <button
                            class="year-filter active px-4 py-2 rounded-lg text-sm font-medium transition-all border-2 border-[#006837] bg-[#006837] text-white"
                            data-year="all"
                        >
                            All
                        </button>
                        {
                            years.map((year) => (
                                <button
                                    class="year-filter px-4 py-2 rounded-lg text-sm font-medium transition-all border-2 border-gray-300 text-gray-700 hover:border-[#006837] hover:bg-gray-100"
                                    data-year={year}
                                >
                                    {year}
                                </button>
                            ))
                        }
                    </div>
                </div>

                {/* Results Count */}
                <div class="mt-4 text-sm text-gray-600">
                    <span id="result-count">{lectures.length}</span> lectures found
                </div>
            </div>

            {/* Past Events - Grouped by Year */}
            {
                years.map((year) => (
                    <div class="mb-16 md:mb-20" data-year-section={year}>
                        {/* Year Header */}
                        <div class="flex items-center gap-4 mb-6 md:mb-8">
                            <div class="flex items-center gap-3">
                                <div class="w-1 h-8 bg-[#006837] rounded-full" />
                                <h2 class="typography-section">
                                    {year}
                                </h2>
                            </div>
                            <div class="flex-1 h-px bg-gray-200" />
                            <span class="text-sm font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                {lecturesByYear[year].length} lectures
                            </span>
                        </div>

                        {/* Lectures for this year */}
                        <div class="space-y-4 md:space-y-6">
                            {lecturesByYear[year].map((lecture) => (
                                <a
                                    href={`/en/lectures/${lecture.id}`}
                                    class="lecture-card-wrapper block group card-tilt smooth-hover"
                                    data-title={getContent(
                                        (lecture as any).title_en,
                                        lecture.title,
                                    ).toLowerCase()}
                                    data-guest={lecture.guest_name.toLowerCase()}
                                    data-year={year.toString()}
                                >
                                    <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden ring-1 ring-gray-100 group-hover:ring-[#006837]/30 lecture-card">
                                        <div class="flex flex-row gap-0">
                                            {/* Image */}
                                            <div class="w-24 sm:w-32 md:w-48 flex-shrink-0 relative overflow-hidden bg-gray-100">
                                                <div class="aspect-[3/4] md:aspect-[210/297]">
                                                    {lecture.eyecatch ? (
                                                        <img
                                                            src={`${lecture.eyecatch.url}?w=192&fm=webp&q=60`}
                                                            srcset={`
                                                        ${lecture.eyecatch.url}?w=96&fm=webp&q=60 96w,
                                                        ${lecture.eyecatch.url}?w=128&fm=webp&q=60 128w,
                                                        ${lecture.eyecatch.url}?w=192&fm=webp&q=60 192w,
                                                        ${lecture.eyecatch.url}?w=256&fm=webp&q=60 256w,
                                                        ${lecture.eyecatch.url}?w=384&fm=webp&q=60 384w
                                                    `}
                                                            sizes="(max-width: 640px) 96px, (max-width: 768px) 128px, 192px"
                                                            alt={getContent(
                                                                (lecture as any)
                                                                    .title_en,
                                                                lecture.title,
                                                            )}
                                                            width="192"
                                                            height="256"
                                                            loading="lazy"
                                                            decoding="async"
                                                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                                        />
                                                    ) : (
                                                        <div class="w-full h-full flex items-center justify-center text-gray-300">
                                                            <svg
                                                                class="w-8 h-8 md:w-12 md:h-12"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                                stroke="currentColor"
                                                            >
                                                                <path
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    stroke-width="1"
                                                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                                                                />
                                                            </svg>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Content */}
                                            <div class="flex-1 p-4 md:p-6 flex flex-col justify-center min-h-0">
                                                {/* Date Badge */}
                                                <div class="inline-flex items-center gap-1.5 w-fit bg-gray-50 border border-gray-200 px-2 py-1 rounded-full mb-2 md:mb-3">
                                                    <svg
                                                        class="w-3 h-3 text-[#006837]"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                                                        />
                                                    </svg>
                                                    <div class="text-xs font-medium text-gray-600">
                                                        {formatDate(
                                                            lecture.event_date,
                                                            "en",
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Title */}
                                                <h3 class="text-base md:text-xl font-bold text-gray-900 mb-1.5 md:mb-2 group-hover:text-[#006837] transition-colors line-clamp-2">
                                                    {getContent(
                                                        (lecture as any)
                                                            .title_en,
                                                        lecture.title,
                                                    )}
                                                </h3>

                                                {/* Guest */}
                                                <p class="text-xs md:text-sm text-gray-600 line-clamp-1">
                                                    {getContent(
                                                        lecture.guest_name_en,
                                                        lecture.guest_name,
                                                    )}
                                                </p>
                                                {lecture.belonging && (
                                                    <p class="text-xs text-gray-500 mb-2 md:mb-3 line-clamp-1">
                                                        {getContent(
                                                            (lecture as any)
                                                                .belonging_en,
                                                            lecture.belonging,
                                                        )}
                                                    </p>
                                                )}

                                                {/* View Details */}
                                                <div class="flex items-center gap-1.5 text-xs md:text-sm font-medium text-[#006837]">
                                                    <span class="hidden sm:inline">
                                                        View Details
                                                    </span>
                                                    <span class="sm:hidden">
                                                        Details
                                                    </span>
                                                    <svg
                                                        class="w-3 h-3 md:w-4 md:h-4 group-hover:translate-x-0.5 transition-transform"
                                                        fill="none"
                                                        viewBox="0 0 24 24"
                                                        stroke="currentColor"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M9 5l7 7-7 7"
                                                        />
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            ))}
                        </div>
                    </div>
                ))
            }
        </div>
    </div>
</Layout>

<script>
    // Search and Filter Functionality
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById(
            "lecture-search",
        ) as HTMLInputElement;
        const yearFilters = document.querySelectorAll(".year-filter");
        const resultCount = document.getElementById("result-count");
        const lectureCards = document.querySelectorAll(".lecture-card-wrapper");

        let currentYear = "all";
        let searchQuery = "";

        // Debounce function
        function debounce<T extends (...args: any[]) => any>(
            func: T,
            delay: number,
        ) {
            let timeout: number | undefined;
            return function (...args: Parameters<T>) {
                clearTimeout(timeout);
                timeout = window.setTimeout(() => func(...args), delay);
            };
        }

        // Filter lectures
        function filterLectures() {
            let visibleCount = 0;
            const yearSections = document.querySelectorAll(
                "[data-year-section]",
            );

            lectureCards.forEach((card) => {
                const cardElement = card;
                const title = cardElement.dataset.title?.toLowerCase() || "";
                const guest = cardElement.dataset.guest?.toLowerCase() || "";
                const year = cardElement.dataset.year || "";

                const matchesSearch =
                    !searchQuery ||
                    title.includes(searchQuery) ||
                    guest.includes(searchQuery);
                const matchesYear =
                    currentYear === "all" || year === currentYear;

                if (matchesSearch && matchesYear) {
                    cardElement.style.display = "";
                    visibleCount++;
                } else {
                    cardElement.style.display = "none";
                }
            });

            // Update year sections visibility
            yearSections.forEach((section) => {
                const sectionElement = section;
                const sectionYear = sectionElement.dataset.yearSection;
                const visibleInSection = Array.from(lectureCards).filter(
                    (card) => {
                        const cardElement = card;
                        return (
                            cardElement.dataset.year === sectionYear &&
                            cardElement.style.display !== "none"
                        );
                    },
                ).length;

                if (visibleInSection > 0) {
                    sectionElement.style.display = "";
                } else {
                    sectionElement.style.display = "none";
                }
            });

            // Update result count
            if (resultCount) {
                resultCount.textContent = visibleCount.toString();
            }
        }

        // Search input handler
        if (searchInput) {
            const debouncedFilter = debounce(() => {
                searchQuery = searchInput.value.toLowerCase();
                filterLectures();
            }, 300);

            searchInput.addEventListener("input", debouncedFilter);
        }

        // Year filter handlers
        yearFilters.forEach((button) => {
            button.addEventListener("click", function (this: HTMLElement) {
                yearFilters.forEach((btn) => {
                    btn.classList.remove(
                        "active",
                        "bg-[#006837]",
                        "text-white",
                        "border-[#006837]",
                    );
                    btn.classList.add("border-gray-300", "text-gray-700");
                });

                this.classList.add(
                    "active",
                    "bg-[#006837]",
                    "text-white",
                    "border-[#006837]",
                );
                this.classList.remove("border-gray-300", "text-gray-700");

                currentYear = this.dataset.year || "all";
                filterLectures();
            });
        });
    });
</script>
