---
import Layout from "../../../layouts/Layout.astro";
import { getCollection, getEntry } from "astro:content";
import type { GetStaticPaths } from "astro";
import Breadcrumb from "../../../components/Breadcrumb.astro";
import BreadcrumbSchema from "../../../components/BreadcrumbSchema.astro";

// Helper function to get English content or fallback to Japanese
const getContent = (item: any, field: string): string => {
    const enField = `${field}_en`;
    return item[enField] || item[field] || "";
};

// Generate static paths for all lectures
export const getStaticPaths = (async () => {
    const lectures = await getCollection("lectures");
    return lectures.map((lecture) => ({
        params: { id: lecture.id },
    }));
}) satisfies GetStaticPaths;

// Get the lecture ID from the URL
const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/en/404");
}

// Fetch the lecture data using Content Layer API
const lectureEntry = await getEntry("lectures", id);

if (!lectureEntry) {
    return Astro.redirect("/en/404");
}

// Map to expected structure (note: English fields may need to be added to schema)
const lecture = {
    id: lectureEntry.id,
    title: lectureEntry.data.title,
    title_en: (lectureEntry.data as any).title_en,
    guest_name: lectureEntry.data.guest_name,
    guest_name_en: (lectureEntry.data as any).guest_name_en,
    belonging: lectureEntry.data.belonging,
    belonging_en: (lectureEntry.data as any).belonging_en,
    event_date: lectureEntry.data.event_date,
    eyecatch: lectureEntry.data.eyecatch,
    content: lectureEntry.data.content,
    content_en: (lectureEntry.data as any).content_en,
};

// Get English content with fallback
const title = getContent(lecture, "title");
const guestName = getContent(lecture, "guest_name");
const belonging = getContent(lecture, "belonging");
const content = getContent(lecture, "content");

// SEO
const seo = {
    title: `${title} - ${guestName} | AIU Cedar Society`,
    description: `Lecture "${title}" by ${guestName}. A lecture series connecting students and society, hosted by AIU Cedar Society. Held on ${new Date(lecture.event_date).toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" })}.`,
    keywords: `${guestName},${title},AIU Cedar Society,lecture,Akita International University,AIU,event`,
    ogImage: lecture.eyecatch?.url || "/ogp-default.jpg",
    ogType: "article" as const,
    article: {
        publishedTime: lecture.event_date,
        author: guestName,
    },
};

// Breadcrumb設定
const breadcrumbItems = [
    { label: "Home", href: "/en" },
    { label: "Past Lectures", href: "/en/events/past" },
    { label: title },
];
---

<Layout seo={seo}>
    <BreadcrumbSchema items={breadcrumbItems} />
    <!-- Reading Progress Bar -->
    <div class="reading-progress-container">
        <div class="reading-progress-bar"></div>
    </div>

    <div class="min-h-screen">
        <div
            class="container mx-auto px-4 md:px-6 pt-16 md:pt-20 pb-12 md:pb-20 max-w-5xl"
        >
            <Breadcrumb items={breadcrumbItems} />
            {/* Back Button */}
            <a
                href="/en"
                class="inline-flex items-center text-gray-500 hover:text-[#006837] mb-8 md:mb-12 transition-colors group text-sm font-medium min-h-[44px]"
            >
                <svg
                    class="w-4 h-4 mr-2 transform group-hover:-translate-x-1 transition-transform"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to List
            </a>

            {/* Header Card */}
            <div
                class="bg-white rounded-lg shadow-md p-6 md:p-10 mb-8 border-l-2 border-[#006837]"
            >
                {/* Date Badge */}
                <div
                    class="inline-flex items-center gap-2 bg-white border border-gray-200 px-4 py-2 rounded-full mb-6 shadow-sm"
                >
                    <svg
                        class="w-4 h-4 text-[#006837]"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        ></path>
                    </svg>
                    <div
                        class="text-base md:text-lg font-bold text-[#006837] tracking-wide"
                    >
                        {
                            new Date(lecture.event_date).toLocaleString(
                                "en-US",
                                {
                                    year: "numeric",
                                    month: "long",
                                    day: "numeric",
                                    weekday: "long",
                                    hour: "2-digit",
                                    minute: "2-digit",
                                    timeZone: "Asia/Tokyo",
                                },
                            )
                        }
                    </div>
                </div>

                <h1 class="typography-hero mb-6 md:mb-8">
                    {title}
                </h1>

                <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
                    <div
                        class="w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-sm flex-shrink-0"
                    >
                        <svg
                            class="w-5 h-5 text-[#006837]"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                            ></path>
                        </svg>
                    </div>
                    <div>
                        <div class="typography-label text-gray-500 mb-1">
                            Speaker
                        </div>
                        <div class="text-lg md:text-xl font-bold text-gray-900">
                            {guestName}
                        </div>
                        {
                            belonging && (
                                <div class="text-sm text-gray-600 mt-1">
                                    {belonging}
                                </div>
                            )
                        }
                    </div>
                </div>

                {/* Image - Subtle placement if exists */}
                {
                    lecture.eyecatch && (
                        <div class="mt-8 flex justify-center">
                            <div class="max-w-[240px] shadow-md rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center p-2">
                                <img
                                    src={`${lecture.eyecatch.url}?w=480&fm=webp&q=60`}
                                    srcset={`${lecture.eyecatch.url}?w=480&fm=webp&q=60 1x, ${lecture.eyecatch.url}?w=960&fm=webp&q=60 2x`}
                                    alt={title}
                                    width="480"
                                    height="480"
                                    loading="eager"
                                    fetchpriority="high"
                                    decoding="async"
                                    class="max-w-full max-h-96 w-auto h-auto object-contain"
                                />
                            </div>
                        </div>
                    )
                }
            </div>

            {/* Content Card */}
            <div class="bg-white rounded-lg shadow-md p-6 md:p-10">
                <div
                    class="flex items-center gap-3 mb-6 pb-6 border-b border-gray-200"
                >
                    <div
                        class="w-6 h-6 bg-[#006837] bg-opacity-5 rounded-lg flex items-center justify-center flex-shrink-0"
                    >
                        <svg
                            class="w-4 h-4 text-[#006837]"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            ></path>
                        </svg>
                    </div>
                    <h2 class="typography-section text-base md:text-xl">
                        Event Details
                    </h2>
                </div>

                {/* Body Content with enhanced prose */}
                <div
                    class="prose prose-slate prose-lg max-w-none leading-relaxed text-gray-700
                prose-headings prose-headings:font-bold prose-headings:text-gray-900 prose-headings:tracking-tight
                prose-h1 prose-h1:text-3xl prose-h1:mt-8 prose-h1:mb-4
                prose-h2 prose-h2:text-2xl prose-h2:mt-6 prose-h2:mb-3
                prose-h3 prose-h3:text-xl prose-h3:mt-4 prose-h3:mb-2
                prose-p:my-4
                prose-a:text-[#006837] prose-a:font-medium prose-a:no-underline hover:prose-a:underline
                prose-strong:text-gray-900 prose-strong:font-bold
                prose-em:text-gray-700 prose-em:italic
                prose-ul:my-4 prose-ul:list-disc prose-ul:pl-6
                prose-ol:my-4 prose-ol:list-decimal prose-ol:pl-6
                prose-li:my-1
                prose-blockquote:border-l-4 prose-blockquote:border-[#006837] prose-blockquote:pl-4 prose-blockquote:italic
                prose-code:bg-gray-100 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:text-sm
                prose-pre:bg-gray-900 prose-pre:text-gray-100
                prose-img:rounded-lg prose-img:shadow-md"
                >
                    <div set:html={content} />
                </div>
            </div>

            {/* Footer */}
            <div class="mt-12 pt-8 border-t border-gray-200 text-center">
                <div
                    class="inline-flex items-center gap-2 text-xs text-gray-400 tracking-wider font-medium"
                >
                    <svg
                        class="w-4 h-4"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <span>AIU CEDAR SOCIETY</span>
                </div>
            </div>
        </div>
    </div>
</Layout>

<style>
    /* Reading Progress Bar Styles */
    .reading-progress-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: rgba(0, 0, 0, 0.05);
        z-index: 9999;
    }

    .reading-progress-bar {
        height: 100%;
        background: linear-gradient(to right, #006837, #00a84f);
        width: 0%;
        transition: width 0.1s ease-out;
    }
</style>

<script>
    // Reading Progress Bar
    window.addEventListener(
        "scroll",
        function () {
            const winScroll =
                document.body.scrollTop || document.documentElement.scrollTop;
            const height =
                document.documentElement.scrollHeight -
                document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;

      const progressBar = document.querySelector(
        ".reading-progress-bar",
      );
            if (progressBar) {
        (progressBar as any).style.width = scrolled + "%";
            }
        },
        { passive: true },
    );
</script>
