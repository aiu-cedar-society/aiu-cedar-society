---
import Layout from "../layouts/Layout.astro";
import Breadcrumb from "../components/Breadcrumb.astro";
import BreadcrumbSchema from "../components/BreadcrumbSchema.astro";
import { getPages, type FAQItem } from "../library/microcms";

// Fetch FAQs from Pages API
let faqs: FAQItem[] = [];
try {
    const pages = await getPages();
    faqs = pages.faqs || [];
} catch (error) {
    console.error("Error fetching FAQs:", error);
}

// SEO
const seo = {
    title: "よくあるご質問 | AIU Cedar Society",
    description:
        "AIU Cedar Societyに関するよくあるご質問をまとめました。団体について、イベントについて、参加方法などをご確認いただけます。",
    keywords: "AIU Cedar Society,FAQ,よくあるご質問,Q&A",
};

const breadcrumbItems = [
    { label: "ホーム", href: "/" },
    { label: "よくあるご質問" },
];
---

<Layout seo={seo}>
    <BreadcrumbSchema items={breadcrumbItems} />
    <div class="bg-gradient-to-b from-gray-50 to-white min-h-screen">
        <div
            class="container mx-auto px-4 md:px-6 pt-16 md:pt-20 pb-12 md:pb-20 max-w-5xl"
        >
            <Breadcrumb items={breadcrumbItems} />
            {/* Back Button */}
            <a
                href="/"
                class="inline-flex items-center text-gray-500 hover:text-[#006837] mb-8 md:mb-12 transition-colors group text-sm font-medium min-h-[44px]"
            >
                <svg
                    class="w-4 h-4 mr-2 transform group-hover:-translate-x-1 transition-transform"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
                ホームへ
            </a>

            {/* Hero Section */}
            <div class="relative mb-12 md:mb-16" data-animate>
                <div class="relative mb-6">
                    <div class="absolute top-0 left-0 w-px h-full bg-[#006837]">
                    </div>
                    <h1
                        class="text-4xl md:text-5xl lg:text-6xl font-bold text-gray-900 tracking-tight leading-tight pl-6"
                    >
                        よくある<span class="text-[#006837]">ご質問</span>
                    </h1>
                </div>
                <p
                    class="text-lg md:text-xl text-gray-600 leading-relaxed pl-6 max-w-2xl"
                >
                    AIU Cedar Societyに関するよくあるご質問をまとめました
                </p>
            </div>

            {/* FAQ Accordion */}
            <div class="space-y-4 faq-list max-w-3xl mx-auto">
                {
                    faqs.length > 0 ? (
                        faqs.map((faq, index) => (
                            <div
                                class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-100 hover-lift faq-card"
                                data-animate
                                data-animate-delay={Math.min(index + 1, 5)}
                            >
                                <button
                                    class="faq-button w-full px-6 py-5 text-left flex items-center justify-between transition-colors"
                                    aria-expanded="false"
                                    aria-controls={`faq-content-${index}`}
                                    data-index={index}
                                >
                                    <div class="flex items-start gap-4">
                                        <span class="flex-shrink-0 w-8 h-8 bg-[#006837] bg-opacity-10 text-[#006837] rounded-full flex items-center justify-center font-bold text-sm transition-transform">
                                            Q
                                        </span>
                                        <span class="font-bold text-gray-900 text-left leading-relaxed">
                                            {faq.question}
                                        </span>
                                    </div>
                                    <svg
                                        class="faq-icon w-5 h-5 text-gray-500 flex-shrink-0 ml-4 transition-transform duration-300"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 9l-7 7-7-7"
                                        />
                                    </svg>
                                </button>
                                <div
                                    id={`faq-content-${index}`}
                                    class="faq-content px-6 max-h-0 overflow-hidden"
                                    data-content={index}
                                    aria-hidden="true"
                                >
                                    <div class="faq-content-inner flex items-center gap-4 pl-0">
                                        <span class="flex-shrink-0 w-8 h-8 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center font-bold text-sm">
                                            A
                                        </span>
                                        <div
                                            class="prose prose-sm max-w-none text-gray-700 leading-relaxed"
                                            set:html={faq.answer}
                                        />
                                    </div>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div class="bg-white rounded-lg shadow-md p-8 text-center">
                            <svg
                                class="w-16 h-16 text-gray-300 mx-auto mb-4"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                />
                            </svg>
                            <p class="text-gray-500 text-lg">
                                FAQは現在準備中です
                            </p>
                            <p class="text-gray-400 text-sm mt-2">
                                近日中に公開予定です
                            </p>
                        </div>
                    )
                }
            </div>

            {/* Contact CTA */}
            <div class="mt-12 bg-[#006837] rounded-lg p-6 md:p-8 max-w-3xl mx-auto">
                <div class="md:flex md:items-center md:justify-between gap-4">
                    <div class="mb-4 md:mb-0">
                        <h3 class="text-lg font-bold text-white mb-2">
                            お探しの質問が見つかりませんか？
                        </h3>
                        <p class="text-white text-opacity-90 text-sm md:text-base">
                            その他のご質問やご不明な点がございましたら、お気軽にお問い合わせください。
                        </p>
                    </div>
                    <a
                        href="/contact"
                        class="inline-flex items-center justify-center gap-2 bg-white text-[#006837] font-bold py-3 px-6 rounded-lg hover:bg-gray-100 transition-colors duration-300 whitespace-nowrap"
                    >
                        お問い合わせ
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script is:inline>
    // FAQ Accordion with per-button handlers (robust across reloads/page swaps)
    (function () {
        function initFaq() {
            const buttons = document.querySelectorAll(".faq-button");

            // Remove old listeners by cloning buttons
            buttons.forEach((btn) => {
                const cloned = btn.cloneNode(true);
                btn.replaceWith(cloned);
            });

            const freshButtons = document.querySelectorAll(".faq-button");
            const contents = document.querySelectorAll(".faq-content");

            // Normalize any leftover padding classes from previous versions
            contents.forEach((c) => {
                c.classList.remove("pb-0", "pb-5");
                c.style.maxHeight = "0px";
                c.setAttribute("aria-hidden", "true");
            });

            function closeOthers(except) {
                freshButtons.forEach((b) => {
                    if (b === except) return;
                    const content = b.nextElementSibling;
                    const icon = b.querySelector(".faq-icon");
                    const card = b.closest(".faq-card");
                    const wasExpanded =
                        b.getAttribute("aria-expanded") === "true";
                    b.setAttribute("aria-expanded", "false");
                    if (content) {
                        content.setAttribute("aria-hidden", "true");
                        if (wasExpanded) {
                            // animate close (from current height to 0)
                            const currentH = content.scrollHeight;
                            content.style.maxHeight = `${currentH}px`;
                            void content.offsetHeight;
                            content.style.maxHeight = "0px";
                        } else {
                            content.style.maxHeight = "0px";
                        }
                    }
                    icon?.classList.remove("rotate-180");
                    // remove open styles after collapse finishes
                    if (card) {
                        setTimeout(() => card.classList.remove("faq-open"), 280);
                    }
                });
            }

            freshButtons.forEach((button) => {
                button.addEventListener("click", () => {
                    const content = button.nextElementSibling;
                    const icon = button.querySelector(".faq-icon");
                    const card = button.closest(".faq-card");
                    const isExpanded =
                        button.getAttribute("aria-expanded") === "true";

                    if (!isExpanded) {
                        closeOthers(button);
                    }

                    const nextState = !isExpanded;
                    button.setAttribute("aria-expanded", String(nextState));
                    if (content) {
                        content.setAttribute("aria-hidden", String(!nextState));
                        if (nextState) {
                            card?.classList.add("faq-open");
                            // animate open (single phase)
                            content.style.maxHeight = "0px";
                            void content.offsetHeight;
                            const h = content.scrollHeight;
                            content.style.maxHeight = `${h}px`;

                            // after animation, release max-height so layout is always correct
                            const onEnd = (ev) => {
                                if (ev.propertyName !== "max-height") return;
                                content.removeEventListener("transitionend", onEnd);
                                if (button.getAttribute("aria-expanded") === "true") {
                                    content.style.maxHeight = "none";
                                }
                            };
                            content.addEventListener("transitionend", onEnd);
                        } else {
                            // if max-height was released, restore to scrollHeight before closing
                            if (content.style.maxHeight === "none") {
                                content.style.maxHeight = `${content.scrollHeight}px`;
                                void content.offsetHeight;
                            }
                            const currentH = content.scrollHeight;
                            content.style.maxHeight = `${currentH}px`;
                            void content.offsetHeight;
                            content.style.maxHeight = "0px";
                            if (card) {
                                setTimeout(
                                    () => card.classList.remove("faq-open"),
                                    280,
                                );
                            }
                        }
                    }

                    icon?.classList.toggle("rotate-180", nextState);
                    // note: faq-open is toggled with timing above to keep padding consistent during animation
                });
            });
        }

        document.addEventListener("DOMContentLoaded", initFaq);
        document.addEventListener("astro:page-load", initFaq);
    })();
</script>

<style>
    .faq-card {
        transition: border-color 0.2s ease, box-shadow 0.2s ease,
            background-color 0.2s ease;
    }

    .faq-card.faq-open {
        border-color: rgba(0, 104, 55, 0.35);
        box-shadow:
            0 12px 24px -12px rgba(0, 0, 0, 0.12),
            0 0 0 1px rgba(0, 104, 55, 0.08);
        background: linear-gradient(
            180deg,
            rgba(0, 104, 55, 0.04),
            rgba(0, 168, 85, 0.04)
        );
    }

    .faq-button {
        gap: 12px;
    }

    .faq-content {
        transition: max-height 300ms ease-out;
        will-change: max-height;
    }

    /* Keep answer padding inside so open doesn't feel like a 2-step jump */
    .faq-content-inner {
        padding-top: 1rem;
        padding-bottom: 1rem;
    }

    /* Remove default margins from typography plugin for better vertical centering */
    .faq-content-inner .prose > :first-child {
        margin-top: 0 !important;
    }
    .faq-content-inner .prose > :last-child {
        margin-bottom: 0 !important;
    }

    .faq-button:hover {
        background: linear-gradient(
            90deg,
            rgba(0, 104, 55, 0.05),
            rgba(0, 168, 85, 0.02)
        );
    }

    .faq-icon {
        transition: transform 0.25s ease, color 0.2s ease;
    }

    .faq-card.faq-open .faq-icon {
        color: #006837;
    }
</style>
